---
/**
 * Source link component
 * Displays clickable link to PDF source document
 */

import { parseSource, getSourceDisplayText } from '../../utils/sourceParser';

interface Props {
  source: string;
  company: string;
  year: number;
  showIcon?: boolean;
  className?: string;
}

const { source, company, year, showIcon = true, className = '' } = Astro.props;

const baseUrl = import.meta.env.BASE_URL || '';
const normalizedBase = baseUrl.endsWith('/') ? baseUrl.slice(0, -1) : baseUrl;
const parsed = parseSource(source);
const displayText = getSourceDisplayText(source);
const filename = (parsed.filename || '').trim();
const companyName = (company || '').trim();
const numericYear = Number(year);
const hasPdfName = filename.toLowerCase().endsWith('.pdf');
const hasPathInputs = Boolean(companyName && hasPdfName && Number.isFinite(numericYear));

let rawPdfPath = '#';
if (hasPathInputs) {
  const pathSegments = [
    '',
    'source_documents',
    encodeURIComponent(companyName),
    encodeURIComponent(String(numericYear)),
    encodeURIComponent(filename)
  ];
  rawPdfPath = pathSegments.join('/');
  if (parsed.page > 0) {
    rawPdfPath = `${rawPdfPath}#page=${parsed.page}`;
  }
}

const pdfUrl = rawPdfPath === '#' ? '#' : `${normalizedBase}${rawPdfPath}`;
const isValid = rawPdfPath !== '#';
---

<a
  href={pdfUrl}
  target="_blank"
  rel="noopener noreferrer"
  class:list={[
    'inline-flex items-center gap-1.5 text-sm transition-colors',
    isValid
      ? 'text-sky-300 hover:text-sky-200 hover:underline'
      : 'text-slate-500 cursor-not-allowed',
    className
  ]}
  title={isValid ? `Open ${displayText} in new tab` : 'PDF source not available'}
>
  {showIcon && <span class="text-base" aria-hidden="true">ðŸ“„</span>}
  <span class="font-medium">{displayText}</span>
  {isValid && showIcon && <span class="text-xs" aria-hidden="true">â†—</span>}
</a>

<style>
  a[href="#"] {
    pointer-events: none;
  }
</style>
