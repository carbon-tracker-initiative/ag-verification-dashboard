---
/**
 * Question Benchmark Component
 * Compares performance of specific questions across all companies
 */

import type { CrossCompanyMetrics } from '../../types/metrics';

interface Props {
  crossCompanyMetrics: CrossCompanyMetrics;
}

const { crossCompanyMetrics } = Astro.props;

// Get top and bottom questions by evidence depth (with safety check)
const rankings = crossCompanyMetrics.question_rankings || [];

const topQuestions = rankings.length > 0
  ? [...rankings].sort((a, b) => b.average_evidence_depth - a.average_evidence_depth).slice(0, 10)
  : [];

const bottomQuestions = rankings.length > 0
  ? [...rankings].sort((a, b) => a.average_evidence_depth - b.average_evidence_depth).slice(0, 10)
  : [];

// Get questions sorted by companies with full disclosure (as a proxy for consistency)
const highVarianceQuestions = rankings.length > 0
  ? [...rankings].sort((a, b) => a.companies_with_full_disclosure - b.companies_with_full_disclosure).slice(0, 10)
  : [];
---

<div class="surface rounded-2xl border border-slate-700/60 p-6 sm:p-8">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-6">
    <div class="flex items-center gap-3 text-sky-300">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <h2 class="text-xl font-semibold text-slate-100 tracking-tight">
        Question Benchmarking Across Companies
      </h2>
    </div>
    <p class="text-xs uppercase tracking-[0.2em] text-slate-500">
      Compare evidence depth performance
    </p>
  </div>

  <p class="text-sm text-slate-400 mb-6 max-w-3xl">
    Review which questions receive the strongest evidence coverage, where disclosure gaps persist, and which topics vary the most across companies.
  </p>

  <!-- Tabs -->
  <div class="flex flex-wrap gap-2 pb-2 mb-6 border-b border-slate-700/60" role="tablist" aria-label="Question performance views">
    <button
      class="qb-tab inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all border border-transparent text-slate-400 hover:text-slate-100 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/50"
      data-tab="top-performers"
      aria-pressed="true"
    >
      <span class="h-2 w-2 rounded-full bg-emerald-400/80"></span>
      Top Performers
    </button>
    <button
      class="qb-tab inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all border border-transparent text-slate-400 hover:text-slate-100 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/50"
      data-tab="bottom-performers"
      aria-pressed="false"
    >
      <span class="h-2 w-2 rounded-full bg-rose-400/80"></span>
      Disclosure Gaps
    </button>
    <button
      class="qb-tab inline-flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all border border-transparent text-slate-400 hover:text-slate-100 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/50"
      data-tab="high-variance"
      aria-pressed="false"
    >
      <span class="h-2 w-2 rounded-full bg-amber-400/80"></span>
      High Variance
    </button>
  </div>

  <!-- Top Performers Tab -->
  <div id="tab-top-performers" class="qb-content space-y-3">
    {topQuestions.length === 0 ? (
      <div class="rounded-xl border border-slate-700 bg-slate-900/70 p-10 text-center text-slate-400">
        No question data available. Make sure analytics data is being generated correctly.
      </div>
    ) : (
      topQuestions.map((q, index) => (
        <div class="rounded-xl border border-emerald-400/35 bg-slate-950/60 px-5 py-4 transition-all hover:border-emerald-300/60">
          <div class="flex items-start gap-4">
            <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-emerald-500/15 text-sm font-semibold text-emerald-200">
              #{index + 1}
            </div>
            <div class="flex-1">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-slate-500 mb-1">
                    {q.question_id}
                  </div>
                  <h3 class="text-sm font-semibold leading-snug text-slate-100">
                    {q.question_text}
                  </h3>
                  <div class="mt-2 inline-flex items-center gap-2 rounded-full bg-slate-900/80 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">
                    {q.category}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-semibold text-emerald-300">
                    {q.average_evidence_depth.toFixed(1)}
                  </div>
                  <div class="text-xs text-slate-500">Avg snippets per company</div>
                </div>
              </div>
              <div class="mt-4 grid gap-3 text-xs text-slate-400 sm:grid-cols-2 lg:grid-cols-4">
                <div>
                  <span class="text-slate-500">Companies with full disclosure</span>
                  <div class="font-semibold text-slate-200">{q.companies_with_full_disclosure}</div>
                </div>
                <div>
                  <span class="text-slate-500">Companies analysed</span>
                  <div class="font-semibold text-slate-200">{q.companies_analyzed}</div>
                </div>
                <div>
                  <span class="text-slate-500">Total snippets</span>
                  <div class="font-semibold text-slate-200">{q.total_snippets_across_companies}</div>
                </div>
                <div>
                  <span class="text-slate-500">Avg financial rate</span>
                  <div class="font-semibold text-slate-200">
                    {q.average_financial_rate.toFixed(1)}%
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      ))
    )}
  </div>

  <!-- Bottom Performers Tab -->
  <div id="tab-bottom-performers" class="qb-content hidden space-y-3">
    {bottomQuestions.length === 0 ? (
      <div class="rounded-xl border border-slate-700 bg-slate-900/70 p-10 text-center text-slate-400">
        No question data available. Make sure analytics data is being generated correctly.
      </div>
    ) : (
      bottomQuestions.map((q, index) => (
        <div class="rounded-xl border border-rose-400/35 bg-slate-950/60 px-5 py-4 transition-all hover:border-rose-300/60">
          <div class="flex items-start gap-4">
            <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-rose-500/15 text-sm font-semibold text-rose-200">
              #{index + 1}
            </div>
            <div class="flex-1">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-slate-500 mb-1">
                    {q.question_id}
                  </div>
                  <h3 class="text-sm font-semibold leading-snug text-slate-100">
                    {q.question_text}
                  </h3>
                </div>
                <div class="text-right">
                  <div class="text-2xl font-semibold text-rose-200">
                    {q.average_evidence_depth.toFixed(1)}
                  </div>
                  <div class="text-xs text-slate-500">Avg snippets per company</div>
                </div>
              </div>
              <div class="mt-3 text-xs text-slate-400">
                {q.companies_with_full_disclosure} of {q.companies_analyzed} companies provide actionable evidence for this question.
              </div>
            </div>
          </div>
        </div>
      ))
    )}
  </div>

  <!-- High Variance Tab -->
  <div id="tab-high-variance" class="qb-content hidden space-y-3">
    {highVarianceQuestions.length === 0 ? (
      <div class="rounded-xl border border-slate-700 bg-slate-900/70 p-10 text-center text-slate-400">
        No question data available. Make sure analytics data is being generated correctly.
      </div>
    ) : (
      highVarianceQuestions.map((q, index) => (
        <div class="rounded-xl border border-amber-400/35 bg-slate-950/60 px-5 py-4 transition-all hover:border-amber-300/60">
          <div class="flex items-start gap-4">
            <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-amber-500/15 text-sm font-semibold text-amber-200">
              #{index + 1}
            </div>
            <div class="flex-1">
              <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                <div>
                  <div class="text-[10px] font-mono uppercase tracking-[0.3em] text-slate-500 mb-1">
                    {q.question_id}
                  </div>
                  <h3 class="text-sm font-semibold leading-snug text-slate-100">
                    {q.question_text}
                  </h3>
                </div>
                <div class="text-right">
                  <div class="text-xs uppercase tracking-[0.3em] text-slate-400">
                    Full disclosure coverage
                  </div>
                  <div class="text-2xl font-semibold text-amber-200">
                    {q.companies_with_full_disclosure} / {q.companies_analyzed}
                  </div>
                </div>
              </div>
              <div class="mt-3 text-xs text-slate-400">
                Explore why some companies excel while others fall behind to develop targeted disclosure guidance.
              </div>
            </div>
          </div>
        </div>
      ))
    )}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll<HTMLButtonElement>('.qb-tab');
    const contents = document.querySelectorAll<HTMLElement>('.qb-content');

    const activeClasses = [
      'bg-slate-900/70',
      'border-slate-600',
      'text-sky-300',
      'shadow-[0_12px_28px_-18px_rgba(56,189,248,0.45)]'
    ];
    const inactiveClasses = ['bg-transparent', 'border-transparent', 'text-slate-400'];

    function setTab(target: string) {
      tabs.forEach(tab => {
        const match = tab.dataset.tab === target;
        tab.setAttribute('aria-pressed', String(match));
        if (match) {
          tab.classList.remove(...inactiveClasses);
          tab.classList.add(...activeClasses);
        } else {
          tab.classList.remove(...activeClasses);
          tab.classList.add(...inactiveClasses);
        }
      });

      contents.forEach(content => {
        if (content.id === `tab-${target}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.tab;
        if (target) {
          setTab(target);
        }
      });
    });

    setTab('top-performers');
  });
</script>

<style>
  .qb-content {
    animation: fadeIn 0.25s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
