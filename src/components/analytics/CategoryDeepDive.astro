---
/**
 * Category Deep Dive Component
 * Detailed analysis of each risk category across companies
 */

import type { CrossCompanyMetrics } from '../../types/metrics';
import categoriesConfig from '../../config/categories.json';

interface Props {
  crossCompanyMetrics: CrossCompanyMetrics;
}

const { crossCompanyMetrics } = Astro.props;
---

<div class="space-y-6">
  {categoriesConfig.categories.map(category => {
    const categoryStats = crossCompanyMetrics.category_breakdown.find(
      c => c.category_name === category.name
    );

    if (!categoryStats) return null;

    return (
      <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
        <!-- Category Header -->
        <div
          class="p-6 bg-gradient-to-r from-slate-50 to-white border-b border-slate-200"
          style={`border-left: 4px solid ${category.color}`}
        >
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-2">
                <span class="text-3xl">{category.icon}</span>
                <h2 class="text-xl font-bold text-slate-800">{category.name}</h2>
              </div>
              <p class="text-sm text-slate-600 mb-4">
                {categoryStats.total_questions} questions across {categoryStats.company_count} companies
              </p>

              <!-- Key Metrics Grid -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <div class="text-2xl font-bold" style={`color: ${category.color}`}>
                    {categoryStats.average_score.toFixed(1)}%
                  </div>
                  <div class="text-xs text-slate-500">Average Score</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-emerald-600">
                    {categoryStats.financial_rate.toFixed(0)}%
                  </div>
                  <div class="text-xs text-slate-500">Financial Disclosure</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-blue-600">
                    {categoryStats.average_snippets.toFixed(1)}
                  </div>
                  <div class="text-xs text-slate-500">Avg Snippets/Question</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-slate-800">
                    {categoryStats.full_disclosure_rate.toFixed(0)}%
                  </div>
                  <div class="text-xs text-slate-500">Full Disclosure Rate</div>
                </div>
              </div>
            </div>

            <!-- Best Company Badge -->
            {categoryStats.best_company && (
              <div class="flex-shrink-0 text-right">
                <div class="text-xs text-slate-500 mb-1">Best Performance</div>
                <div class="px-3 py-2 bg-emerald-100 border border-emerald-300 rounded-lg">
                  <div class="text-sm font-bold text-emerald-800">
                    {categoryStats.best_company.company_name}
                  </div>
                  <div class="text-xs text-emerald-600">
                    {categoryStats.best_company.score.toFixed(1)}%
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>

        <!-- Category Details -->
        <div class="p-6">
          <!-- Classification Distribution -->
          <div class="mb-6">
            <h3 class="text-sm font-semibold text-slate-700 mb-3">Classification Distribution</h3>
            <div class="space-y-2">
              <div>
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs text-slate-600">Full Disclosure</span>
                  <span class="text-xs font-semibold text-emerald-600">
                    {categoryStats.full_disclosure_count} ({categoryStats.full_disclosure_rate.toFixed(0)}%)
                  </span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                  <div
                    class="bg-emerald-500 h-2 rounded-full transition-all"
                    style={`width: ${categoryStats.full_disclosure_rate}%`}
                  ></div>
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs text-slate-600">Partial</span>
                  <span class="text-xs font-semibold text-amber-600">
                    {categoryStats.partial_count} ({categoryStats.partial_rate.toFixed(0)}%)
                  </span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                  <div
                    class="bg-amber-500 h-2 rounded-full transition-all"
                    style={`width: ${categoryStats.partial_rate}%`}
                  ></div>
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs text-slate-600">Unclear</span>
                  <span class="text-xs font-semibold text-slate-600">
                    {categoryStats.unclear_count} ({categoryStats.unclear_rate.toFixed(0)}%)
                  </span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                  <div
                    class="bg-slate-400 h-2 rounded-full transition-all"
                    style={`width: ${categoryStats.unclear_rate}%`}
                  ></div>
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between mb-1">
                  <span class="text-xs text-slate-600">No Disclosure</span>
                  <span class="text-xs font-semibold text-red-600">
                    {categoryStats.no_disclosure_count} ({categoryStats.no_disclosure_rate.toFixed(0)}%)
                  </span>
                </div>
                <div class="w-full bg-slate-200 rounded-full h-2">
                  <div
                    class="bg-red-500 h-2 rounded-full transition-all"
                    style={`width: ${categoryStats.no_disclosure_rate}%`}
                  ></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Company Performance Breakdown -->
          <div>
            <h3 class="text-sm font-semibold text-slate-700 mb-3">Company Performance</h3>
            <div class="space-y-2">
              {categoryStats.company_scores
                .sort((a, b) => b.score - a.score)
                .map((company, index) => {
                  const gradeColor = company.score >= 90 ? 'emerald' :
                                   company.score >= 80 ? 'blue' :
                                   company.score >= 70 ? 'amber' :
                                   company.score >= 60 ? 'orange' : 'red';

                  return (
                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors">
                      <div class="flex-shrink-0 w-8 text-center">
                        <span class="text-sm font-bold text-slate-600">#{index + 1}</span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between gap-2">
                          <span class="text-sm font-semibold text-slate-800 truncate">
                            {company.company_name}
                          </span>
                          <div class="flex items-center gap-2 flex-shrink-0">
                            <span class={`text-sm font-bold text-${gradeColor}-600`}>
                              {company.score.toFixed(1)}%
                            </span>
                            <span class={`text-xs px-2 py-0.5 rounded font-bold bg-${gradeColor}-100 text-${gradeColor}-700`}>
                              {company.grade}
                            </span>
                          </div>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                          <div
                            class={`bg-${gradeColor}-500 h-1.5 rounded-full transition-all`}
                            style={`width: ${company.score}%`}
                          ></div>
                        </div>
                      </div>
                    </div>
                  );
                })}
            </div>
          </div>

          <!-- Top Questions in Category -->
          {categoryStats.top_questions && categoryStats.top_questions.length > 0 && (
            <div class="mt-6">
              <h3 class="text-sm font-semibold text-slate-700 mb-3">Top Performing Questions</h3>
              <div class="space-y-2">
                {categoryStats.top_questions.slice(0, 5).map(q => (
                  <div class="p-3 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <div class="flex items-start justify-between gap-2 mb-1">
                      <span class="text-xs font-mono text-emerald-700">{q.question_id}</span>
                      <span class="text-xs font-bold text-emerald-600">{q.average_score.toFixed(0)}%</span>
                    </div>
                    <div class="text-xs text-slate-700">{q.question_text}</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <!-- Bottom Questions in Category -->
          {categoryStats.bottom_questions && categoryStats.bottom_questions.length > 0 && (
            <div class="mt-6">
              <h3 class="text-sm font-semibold text-slate-700 mb-3">Needs Improvement</h3>
              <div class="space-y-2">
                {categoryStats.bottom_questions.slice(0, 5).map(q => (
                  <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex items-start justify-between gap-2 mb-1">
                      <span class="text-xs font-mono text-red-700">{q.question_id}</span>
                      <span class="text-xs font-bold text-red-600">{q.average_score.toFixed(0)}%</span>
                    </div>
                    <div class="text-xs text-slate-700">{q.question_text}</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    );
  })}
</div>
