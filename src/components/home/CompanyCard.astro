---
/**
 * Company card for home page
 * Shows company summary with link to detail page
 */

import type { CompanyMetrics } from '../../types/metrics';
import type { SectorCode } from '../../types/questions';
import { formatNumber, formatPercentage } from '../../utils/formatters';

interface Props {
  company: CompanyMetrics;
  year: number;
  companyName: string;
  version: string;
  sector?: SectorCode;
}

const {
  company,
  year,
  companyName,
  version,
  sector
} = Astro.props;

const totalSnippets = company.total_snippets || 0;
const disclosureCount =
  (company.snippets_by_classification.FULL_DISCLOSURE || 0) +
  (company.snippets_by_classification.PARTIAL || 0);
const disclosureRate = totalSnippets ? (disclosureCount / totalSnippets) * 100 : 0;

const financialFull = company.snippets_with_financial_full || 0;
const financialPartial = company.snippets_with_financial_partial || 0;
const financialTotal = financialFull + financialPartial;
const financialRate = totalSnippets ? (financialTotal / totalSnippets) * 100 : 0;
const financialPct = {
  full: totalSnippets ? (financialFull / totalSnippets) * 100 : 0,
  partial: totalSnippets ? (financialPartial / totalSnippets) * 100 : 0
};

const sectorLabelMap: Record<SectorCode | 'ALL', { short: string; long: string }> = {
  F: { short: 'F', long: 'Fertilizers' },
  P: { short: 'P', long: 'Crop protection' },
  PF: { short: 'F&P', long: 'Fertilizers & Crop protection' },
  // Treat unknown/all-sector companies as operating across both segments for display
  ALL: { short: 'F&P', long: 'Fertilizers & Crop protection' }
};

const sectorInfo = sector ? sectorLabelMap[sector] || sectorLabelMap.ALL : sectorLabelMap.ALL;
---

<div class="surface flex flex-col h-full p-6 transition-transform duration-200 hover:-translate-y-1">
  <div class="flex items-start justify-between mb-5">
    <div>
      <div class="flex items-center gap-2 mb-1">
        <h3 class="text-lg font-semibold text-slate-100">{company.company_name}</h3>
      </div>
      <p class="text-sm text-slate-400">Calendar Year {company.fiscal_year}</p>
    </div>
    <div class="flex items-center gap-2">
      <span class="px-2 py-0.5 rounded-full border border-slate-700 bg-slate-900/70 text-[11px] font-semibold uppercase tracking-wide text-slate-200">
        {sectorInfo.short}
      </span>
      <span class="text-[11px] text-slate-400">{sectorInfo.long}</span>
    </div>
  </div>

  <div class="space-y-3 mb-5">
    <div class="flex items-center gap-2">
      <span class="text-xs text-slate-500 w-28 uppercase tracking-wide">Disclosure</span>
      <div class="flex-1 bg-slate-900 rounded-full h-2">
        <div
          class="bg-sky-400 h-2 rounded-full transition-all"
          style={`width: ${disclosureRate}%`}
        ></div>
      </div>
      <span class="text-xs font-semibold text-slate-200 w-12 text-right">
        {formatPercentage(disclosureRate, 0)}
      </span>
    </div>
    <div class="flex items-center gap-2">
      <span class="text-xs text-slate-500 w-28 uppercase tracking-wide">Financial mix</span>
      <div class="flex-1 bg-slate-900 rounded-full h-2">
        <div
          class="bg-purple-400 h-2 rounded-full transition-all"
          style={`width: ${financialRate}%`}
        ></div>
      </div>
      <span class="text-xs font-semibold text-slate-200 w-12 text-right">
        {formatPercentage(financialRate, 0)}
      </span>
    </div>
  </div>

  <div class="grid grid-cols-3 gap-3 text-center mb-6">
    <div>
      <div class="text-lg font-semibold text-slate-100">
        {formatNumber(disclosureCount)}
      </div>
      <div class="text-[11px] uppercase tracking-wide text-slate-500">Disclosures</div>
    </div>
    <div>
      <div class="text-lg font-semibold text-slate-100">
        {formatNumber(company.total_snippets)}
      </div>
      <div class="text-[11px] uppercase tracking-wide text-slate-500">Total Disclosures</div>
    </div>
    <div>
      <div class="text-lg font-semibold text-slate-100">
        {formatPercentage(financialRate, 0)}
      </div>
      <div class="text-[11px] uppercase tracking-wide text-slate-500">Financial share</div>
    </div>
  </div>

  <div class="text-xs text-slate-400 bg-slate-900/60 border border-slate-800 rounded-lg p-3 mb-4">
    <div class="flex items-center justify-between">
      <span>Financial split</span>
      <span class="text-emerald-200 font-semibold">
        {formatPercentage(financialRate, 0)}
      </span>
    </div>
    <div class="mt-1 text-slate-300">
      <span class="mr-3">Financial: {formatPercentage(financialPct.full, 0)}</span>
      <span>Partial-type: {formatPercentage(financialPct.partial, 0)}</span>
    </div>
  </div>

  <a
    href={`${import.meta.env.BASE_URL}/${companyName.toLowerCase()}/${year}/${version}`}
    class="mt-auto inline-flex items-center justify-center gap-2 rounded-md border border-slate-600 px-4 py-2 text-sm font-semibold text-slate-200 transition-colors hover:border-slate-400 hover:text-slate-50"
  >
    View Analysis
    <span aria-hidden="true">â†’</span>
  </a>
</div>
