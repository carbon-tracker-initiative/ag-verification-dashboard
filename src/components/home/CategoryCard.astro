---
/**
 * Category performance card
 * Shows metrics for one risk category
 */

import type { CategoryMetrics } from '../../types/metrics';
import GradeDisplay from '../shared/GradeDisplay.astro';
import ClassificationBadge from '../shared/ClassificationBadge.astro';

interface Props {
  category: CategoryMetrics;
  expandable?: boolean;
}

const { category, expandable = true } = Astro.props;

// Category icons
const categoryIcons: Record<string, string> = {
  'Environmental Risk': 'ðŸŒ³',
  'Human Health Risk': 'ðŸ¥',
  'Market/Business Risk': 'ðŸ“Š',
  'Regulatory/Financial Risk': 'âš–ï¸'
};

const icon = categoryIcons[category.category_name] || 'ðŸ“‹';

// Calculate percentages for classification distribution
const total = category.total_snippets;
const fullPct = total > 0 ? (category.snippets_by_classification.FULL_DISCLOSURE / total) * 100 : 0;
const partialPct = total > 0 ? (category.snippets_by_classification.PARTIAL / total) * 100 : 0;
const unclearPct = total > 0 ? (category.snippets_by_classification.UNCLEAR / total) * 100 : 0;
const nonePct = total > 0 ? (category.snippets_by_classification.NO_DISCLOSURE / total) * 100 : 0;
---

<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 hover:shadow-md transition-shadow">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <span class="text-3xl">{icon}</span>
      <h3 class="text-lg font-bold text-slate-900">{category.category_name}</h3>
    </div>
    <GradeDisplay score={category.average_question_score} showGrade={true} showScore={true} size="lg" />
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-3 gap-4 mb-4">
    <div class="text-center">
      <div class="text-2xl font-bold text-blue-600">
        {category.questions_answered}/{category.total_questions}
      </div>
      <div class="text-xs text-slate-600">Questions</div>
    </div>
    <div class="text-center">
      <div class="text-2xl font-bold text-purple-600">
        {category.average_evidence_depth.toFixed(1)}
      </div>
      <div class="text-xs text-slate-600">Avg Snippets</div>
    </div>
    <div class="text-center">
      <div class="text-2xl font-bold text-green-600">
        {category.average_financial_rate.toFixed(0)}%
      </div>
      <div class="text-xs text-slate-600">Financial</div>
    </div>
  </div>

  <!-- Classification Distribution Bar -->
  <div class="mb-4">
    <div class="text-xs font-medium text-slate-600 mb-2">Classification Distribution</div>
    <div class="h-8 flex rounded-md overflow-hidden">
      {fullPct > 0 && (
        <div
          class="bg-green-500 hover:bg-green-600 transition-colors flex items-center justify-center text-white text-xs font-semibold"
          style={`width: ${fullPct}%`}
          title={`Full: ${category.snippets_by_classification.FULL_DISCLOSURE} (${fullPct.toFixed(1)}%)`}
        >
          {fullPct > 10 && `${fullPct.toFixed(0)}%`}
        </div>
      )}
      {partialPct > 0 && (
        <div
          class="bg-yellow-500 hover:bg-yellow-600 transition-colors flex items-center justify-center text-white text-xs font-semibold"
          style={`width: ${partialPct}%`}
          title={`Partial: ${category.snippets_by_classification.PARTIAL} (${partialPct.toFixed(1)}%)`}
        >
          {partialPct > 10 && `${partialPct.toFixed(0)}%`}
        </div>
      )}
      {unclearPct > 0 && (
        <div
          class="bg-orange-500 hover:bg-orange-600 transition-colors flex items-center justify-center text-white text-xs font-semibold"
          style={`width: ${unclearPct}%`}
          title={`Unclear: ${category.snippets_by_classification.UNCLEAR} (${unclearPct.toFixed(1)}%)`}
        >
          {unclearPct > 10 && `${unclearPct.toFixed(0)}%`}
        </div>
      )}
      {nonePct > 0 && (
        <div
          class="bg-red-500 hover:bg-red-600 transition-colors flex items-center justify-center text-white text-xs font-semibold"
          style={`width: ${nonePct}%`}
          title={`None: ${category.snippets_by_classification.NO_DISCLOSURE} (${nonePct.toFixed(1)}%)`}
        >
          {nonePct > 10 && `${nonePct.toFixed(0)}%`}
        </div>
      )}
    </div>
  </div>

  <!-- Expandable Questions List -->
  {expandable && category.top_questions.length > 0 && (
    <details class="mt-4">
      <summary class="cursor-pointer text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
        View Top Questions ({category.top_questions.length})
      </summary>
      <ul class="mt-3 space-y-2">
        {category.top_questions.map(q => (
          <li class="text-sm">
            <a
              href={`/analytics#question-${q.question_id}`}
              class="flex items-center justify-between p-2 rounded hover:bg-slate-50 transition-colors"
            >
              <span class="text-slate-700">
                <span class="font-mono text-xs text-slate-500">{q.question_id}:</span>
                {' '}
                <span class="truncate">{q.question_text.substring(0, 60)}...</span>
              </span>
              <GradeDisplay score={q.score} showScore={true} size="sm" />
            </a>
          </li>
        ))}
      </ul>
    </details>
  )}
</div>
