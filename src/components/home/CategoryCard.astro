---
/**
 * Category performance card
 * Shows metrics for one risk category
 */

import type { CategoryMetrics } from '../../types/metrics';
import GradeDisplay from '../shared/GradeDisplay.astro';

interface Props {
  category: CategoryMetrics;
  expandable?: boolean;
}

const { category, expandable = true } = Astro.props;

// Category icons
const categoryIcons: Record<string, string> = {
  'Environmental Risk': 'ðŸŒ±',
  'Human Health Risk': 'ðŸ©º',
  'Market/Business Risk': 'ðŸ“Š',
  'Regulatory/Financial Risk': 'âš–ï¸'
};

const icon = categoryIcons[category.category_name] || 'ðŸ›°ï¸';

// Calculate percentages for classification distribution
const total = category.total_snippets || 0;
const fullPct = total > 0 ? (category.snippets_by_classification.FULL_DISCLOSURE / total) * 100 : 0;
const partialPct = total > 0 ? (category.snippets_by_classification.PARTIAL / total) * 100 : 0;
const unclearPct = total > 0 ? (category.snippets_by_classification.UNCLEAR / total) * 100 : 0;
const nonePct = total > 0 ? (category.snippets_by_classification.NO_DISCLOSURE / total) * 100 : 0;
---

<div class="surface glow-ring p-6">
  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <span class="text-3xl drop-shadow">{icon}</span>
      <h3 class="text-lg font-bold text-slate-100 tracking-tight">{category.category_name}</h3>
    </div>
    <GradeDisplay score={category.average_question_score} showGrade={true} showScore={true} size="lg" />
  </div>

  <!-- Stats Grid -->
  <div class="grid grid-cols-3 gap-4 mb-5">
    <div class="text-center">
      <div class="text-2xl font-bold text-sky-300">
        {category.questions_answered}/{category.total_questions}
      </div>
      <div class="text-xs text-slate-400 uppercase tracking-wide">Questions</div>
    </div>
    <div class="text-center">
      <div class="text-2xl font-bold text-violet-300">
        {category.average_evidence_depth.toFixed(1)}
      </div>
      <div class="text-xs text-slate-400 uppercase tracking-wide">Avg Snippets</div>
    </div>
    <div class="text-center">
      <div class="text-2xl font-bold text-emerald-300">
        {category.average_financial_rate.toFixed(0)}%
      </div>
      <div class="text-xs text-slate-400 uppercase tracking-wide">Financial</div>
    </div>
  </div>

  <!-- Classification Distribution Bar -->
  <div class="mb-5">
    <div class="text-xs font-medium text-slate-300 mb-2 uppercase tracking-wide">Classification Distribution</div>
    <div class="h-8 flex rounded-md overflow-hidden border border-slate-700/70">
      {fullPct > 0 && (
        <div
          class="bg-emerald-500/90 hover:bg-emerald-400 transition-colors flex items-center justify-center text-slate-900 text-xs font-semibold"
          style={`width: ${fullPct}%`}
          title={`Full: ${category.snippets_by_classification.FULL_DISCLOSURE} (${fullPct.toFixed(1)}%)`}
        >
          {fullPct > 10 && `${fullPct.toFixed(0)}%`}
        </div>
      )}
      {partialPct > 0 && (
        <div
          class="bg-amber-500/90 hover:bg-amber-400 transition-colors flex items-center justify-center text-slate-900 text-xs font-semibold"
          style={`width: ${partialPct}%`}
          title={`Partial: ${category.snippets_by_classification.PARTIAL} (${partialPct.toFixed(1)}%)`}
        >
          {partialPct > 10 && `${partialPct.toFixed(0)}%`}
        </div>
      )}
      {unclearPct > 0 && (
        <div
          class="bg-slate-500/90 hover:bg-slate-400 transition-colors flex items-center justify-center text-slate-900 text-xs font-semibold"
          style={`width: ${unclearPct}%`}
          title={`Unclear: ${category.snippets_by_classification.UNCLEAR} (${unclearPct.toFixed(1)}%)`}
        >
          {unclearPct > 10 && `${unclearPct.toFixed(0)}%`}
        </div>
      )}
      {nonePct > 0 && (
        <div
          class="bg-rose-500/90 hover:bg-rose-400 transition-colors flex items-center justify-center text-slate-900 text-xs font-semibold"
          style={`width: ${nonePct}%`}
          title={`None: ${category.snippets_by_classification.NO_DISCLOSURE} (${nonePct.toFixed(1)}%)`}
        >
          {nonePct > 10 && `${nonePct.toFixed(0)}%`}
        </div>
      )}
      {total === 0 && (
        <div class="flex-1 bg-slate-800/90 text-slate-500 text-xs flex items-center justify-center">
          No snippets verified
        </div>
      )}
    </div>
  </div>

  <!-- Expandable Questions List -->
  {expandable && category.top_questions.length > 0 && (
    <details class="mt-4 rounded-lg border border-slate-800/60 bg-slate-900/60">
      <summary class="cursor-pointer text-sm font-medium text-sky-300 hover:text-sky-200 transition-colors px-4 py-3">
        View Top Questions ({category.top_questions.length})
      </summary>
      <ul class="mt-0 space-y-2 px-4 pb-4 pt-1">
        {category.top_questions.map(q => (
          <li class="text-sm">
            <a
              href={`/analytics#question-${q.question_id}`}
              class="flex items-center justify-between gap-3 p-2 rounded-md hover:bg-slate-800/70 transition-colors border border-transparent hover:border-slate-700/80"
            >
              <span class="text-slate-200 flex-1 min-w-0">
                <span class="font-mono text-xs text-slate-400">{q.question_id}:</span>
                {' '}
                <span class="truncate">{q.question_text.substring(0, 60)}{q.question_text.length > 60 ? 'â€¦' : ''}</span>
              </span>
              <GradeDisplay score={q.score} showScore={true} size="sm" />
            </a>
          </li>
        ))}
      </ul>
    </details>
  )}
</div>
