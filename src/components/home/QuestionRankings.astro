---
/**
 * Question rankings component
 * Shows best and worst disclosed questions across all companies
 */

import type { CrossCompanyMetrics } from '../../types/metrics';
import { formatNumber } from '../../utils/formatters';

interface Props {
  questionRankings: CrossCompanyMetrics['question_rankings'];
  sortBy?: 'evidence' | 'question_id' | 'evidence_count';
}

const { questionRankings, sortBy = 'evidence' } = Astro.props;

const baseUrl = import.meta.env.BASE_URL;

let sorted = [...questionRankings];
if (sortBy === 'question_id') {
  sorted.sort((a, b) => a.question_id.localeCompare(b.question_id));
} else if (sortBy === 'evidence_count') {
  sorted.sort((a, b) => b.total_snippets_across_companies - a.total_snippets_across_companies);
} else {
  sorted.sort((a, b) => b.average_evidence_depth - a.average_evidence_depth);
}

const topQuestions = sorted.slice(0, 10);
const bottomQuestions = sorted.slice(-10).reverse();
---

<section class="mb-12">
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <h2 class="text-2xl font-semibold text-slate-50 tracking-tight">Question Performance Rankings</h2>

    <div class="flex gap-2 bg-slate-900/70 border border-slate-800 rounded-lg p-1">
      <a
        href={`${baseUrl}/?sort=evidence`}
        class:list={[
          'px-3 py-1.5 text-sm font-medium rounded-md transition-colors',
          sortBy === 'evidence'
            ? 'bg-slate-800 text-slate-100 border border-slate-700'
            : 'text-slate-300 hover:text-slate-100 hover:bg-slate-800/70'
        ]}
      >
        By Evidence
      </a>
      <a
        href={`${baseUrl}/?sort=question_id`}
        class:list={[
          'px-3 py-1.5 text-sm font-medium rounded-md transition-colors',
          sortBy === 'question_id'
            ? 'bg-slate-800 text-slate-100 border border-slate-700'
            : 'text-slate-300 hover:text-slate-100 hover:bg-slate-800/70'
        ]}
      >
        By ID
      </a>
      <a
        href={`${baseUrl}/?sort=evidence_count`}
        class:list={[
          'px-3 py-1.5 text-sm font-medium rounded-md transition-colors',
          sortBy === 'evidence_count'
            ? 'bg-slate-800 text-slate-100 border border-slate-700'
            : 'text-slate-300 hover:text-slate-100 hover:bg-slate-800/70'
        ]}
      >
        By Evidence
      </a>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-6">
    <!-- Best Disclosed Questions -->
    <div class="surface p-6 border border-emerald-500/20">
      <h3 class="text-lg font-semibold text-emerald-300 mb-4 flex items-center gap-2">
        <span aria-hidden="true">ðŸŸ¢</span>
        <span>Best Disclosed Questions</span>
      </h3>
      <ol class="space-y-3">
        {topQuestions.map((q, index) => (
          <li class="border-b border-slate-800/60 pb-3 last:border-0">
            <div class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-emerald-500/15 text-emerald-200 text-xs font-bold flex items-center justify-center border border-emerald-500/40">
                {index + 1}
              </span>
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between gap-2 mb-1">
                  <span class="font-mono text-xs text-slate-400">{q.question_id}</span>
                  <span class="text-xs font-semibold text-sky-300 whitespace-nowrap">
                    {q.average_evidence_depth.toFixed(1)} avg
                  </span>
                </div>
                <p class="text-sm text-slate-200 line-clamp-2">{q.question_text}</p>
                <div class="flex items-center gap-4 mt-2 text-xs text-slate-400">
                  <span title="evidence disclosures">Snippets: {formatNumber(q.total_snippets_across_companies)}</span>
                  <span title="Companies with full disclosure">
                    Full disclosure: {q.companies_with_full_disclosure}/{q.companies_analyzed}
                  </span>
                </div>
              </div>
            </div>
          </li>
        ))}
      </ol>
    </div>

    <!-- Poorly Disclosed Questions -->
    <div class="surface p-6 border border-amber-500/20">
      <h3 class="text-lg font-semibold text-amber-300 mb-4 flex items-center gap-2">
        <span aria-hidden="true">ðŸŸ </span>
        <span>Poorly Disclosed Questions</span>
      </h3>
      <ol class="space-y-3">
        {bottomQuestions.map((q, index) => (
          <li class="border-b border-slate-800/60 pb-3 last:border-0">
            <div class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-amber-500/15 text-amber-200 text-xs font-bold flex items-center justify-center border border-amber-500/40">
                {sorted.length - 9 + index}
              </span>
              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between gap-2 mb-1">
                  <span class="font-mono text-xs text-slate-400">{q.question_id}</span>
                  <span class="text-xs font-semibold text-sky-300 whitespace-nowrap">
                    {q.average_evidence_depth.toFixed(1)} avg
                  </span>
                </div>
                <p class="text-sm text-slate-200 line-clamp-2">{q.question_text}</p>
                <div class="flex items-center gap-4 mt-2 text-xs text-slate-400">
                  <span title="Evidence disclosures">Snippets: {formatNumber(q.total_snippets_across_companies)}</span>
                  <span title="Companies analyzed">{q.companies_analyzed} companies</span>
                </div>
              </div>
            </div>
          </li>
        ))}
      </ol>
    </div>
  </div>
</section>
