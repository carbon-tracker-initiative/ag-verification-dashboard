---
/**
 * Snippet Card Component
 * Displays detailed snippet information with multi-dimensional scoring
 */

import type { Snippet } from '../../types/analysis';
import ClassificationBadge from '../shared/ClassificationBadge.astro';
import SourceLink from '../shared/SourceLink.astro';
import { calculateSnippetScore, calculateFinancialScore, calculateTemporalScore, calculateNarrativeScore } from '../../utils/metricsCalculator';

interface Props {
  snippet: Snippet;
}

const { snippet } = Astro.props;

// Calculate scores
const totalScore = calculateSnippetScore(snippet);
const financialScore = calculateFinancialScore(snippet);
const temporalScore = calculateTemporalScore(snippet);
const narrativeScore = calculateNarrativeScore(snippet);

// Determine grade color
function getScoreColor(score: number): string {
  if (score >= 90) return 'text-emerald-600';
  if (score >= 80) return 'text-blue-600';
  if (score >= 70) return 'text-amber-600';
  if (score >= 60) return 'text-orange-600';
  return 'text-red-600';
}

function getProgressBarColor(score: number): string {
  if (score >= 90) return 'bg-emerald-500';
  if (score >= 80) return 'bg-blue-500';
  if (score >= 70) return 'bg-amber-500';
  if (score >= 60) return 'bg-orange-500';
  return 'bg-red-500';
}
---

<div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-blue-300 transition-colors">
  <!-- Header: Classification and Overall Score -->
  <div class="flex items-start justify-between gap-3 mb-3">
    <div class="flex items-center gap-2">
      <ClassificationBadge classification={snippet.classification} size="small" />
      <span class="text-xs text-slate-500">ID: {snippet.snippet_id}</span>
    </div>
    <div class="text-right">
      <div class={`text-2xl font-bold ${getScoreColor(totalScore)}`}>
        {totalScore.toFixed(0)}%
      </div>
      <div class="text-xs text-slate-500">Quality Score</div>
    </div>
  </div>

  <!-- Quote -->
  <div class="mb-3 p-3 bg-slate-50 rounded border-l-4 border-blue-400">
    <div class="text-sm text-slate-700 leading-relaxed italic">
      "{snippet.quote}"
    </div>
  </div>

  <!-- Source -->
  <div class="mb-3">
    <SourceLink source={snippet.source} />
  </div>

  <!-- Multi-Dimensional Scoring Breakdown -->
  <div class="mb-3 p-3 bg-gradient-to-br from-blue-50 to-slate-50 rounded-lg border border-slate-200">
    <div class="text-xs font-semibold text-slate-700 mb-3">Score Breakdown</div>

    <!-- Financial Transparency -->
    <div class="mb-2">
      <div class="flex items-center justify-between mb-1">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="text-xs font-medium text-slate-700">Financial Transparency</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-slate-600">{snippet.categorization.financial_type}</span>
          <span class="text-xs font-bold text-emerald-600">{financialScore}/3</span>
        </div>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-1.5">
        <div
          class="bg-emerald-500 h-1.5 rounded-full transition-all"
          style={`width: ${(financialScore / 3) * 100}%`}
        ></div>
      </div>
    </div>

    <!-- Temporal Specificity -->
    <div class="mb-2">
      <div class="flex items-center justify-between mb-1">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span class="text-xs font-medium text-slate-700">Temporal Specificity</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-slate-600">{snippet.categorization.timeframe}</span>
          <span class="text-xs font-bold text-blue-600">{temporalScore}/3</span>
        </div>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-1.5">
        <div
          class="bg-blue-500 h-1.5 rounded-full transition-all"
          style={`width: ${(temporalScore / 3) * 100}%`}
        ></div>
      </div>
    </div>

    <!-- Narrative Framing -->
    <div>
      <div class="flex items-center justify-between mb-1">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
          </svg>
          <span class="text-xs font-medium text-slate-700">Narrative Framing</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-xs text-slate-600">{snippet.categorization.framing}</span>
          <span class="text-xs font-bold text-purple-600">{narrativeScore}/3</span>
        </div>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-1.5">
        <div
          class="bg-purple-500 h-1.5 rounded-full transition-all"
          style={`width: ${(narrativeScore / 3) * 100}%`}
        ></div>
      </div>
    </div>

    <!-- Total Score Progress Bar -->
    <div class="mt-3 pt-3 border-t border-slate-200">
      <div class="flex items-center justify-between mb-1">
        <span class="text-xs font-bold text-slate-700">Composite Score</span>
        <span class={`text-sm font-bold ${getScoreColor(totalScore)}`}>
          {totalScore.toFixed(1)}%
        </span>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-2">
        <div
          class={`${getProgressBarColor(totalScore)} h-2 rounded-full transition-all`}
          style={`width: ${totalScore}%`}
        ></div>
      </div>
      <div class="text-xs text-slate-500 mt-1 text-center">
        ({financialScore} + {temporalScore} + {narrativeScore}) / 9 Ã— 100%
      </div>
    </div>
  </div>

  <!-- Classification Justification -->
  <div class="mb-3">
    <div class="text-xs font-semibold text-slate-600 mb-1">Classification Justification</div>
    <div class="text-xs text-slate-700 p-2 bg-slate-50 rounded border border-slate-200">
      {snippet.classification_justification}
    </div>
  </div>

  <!-- Detailed Justifications (Collapsible) -->
  <details class="mb-3">
    <summary class="text-xs font-semibold text-slate-600 cursor-pointer hover:text-blue-600 flex items-center gap-1">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>View Detailed Justifications</span>
    </summary>
    <div class="mt-2 space-y-2 pl-4">
      <!-- Financial Justification -->
      <div>
        <div class="text-xs font-medium text-emerald-700 mb-1">Financial Type Reasoning</div>
        <div class="text-xs text-slate-600 p-2 bg-emerald-50 rounded border border-emerald-200">
          {snippet.categorization.financial_justification}
        </div>
      </div>

      <!-- Temporal Justification -->
      <div>
        <div class="text-xs font-medium text-blue-700 mb-1">Timeframe Reasoning</div>
        <div class="text-xs text-slate-600 p-2 bg-blue-50 rounded border border-blue-200">
          {snippet.categorization.timeframe_justification}
        </div>
      </div>

      <!-- Framing Justification -->
      <div>
        <div class="text-xs font-medium text-purple-700 mb-1">Framing Reasoning</div>
        <div class="text-xs text-slate-600 p-2 bg-purple-50 rounded border border-purple-200">
          {snippet.categorization.framing_justification}
        </div>
      </div>
    </div>
  </details>

  <!-- Financial Amounts (if any) -->
  {snippet.financial_amounts && snippet.financial_amounts.length > 0 && (
    <div class="mb-3">
      <div class="text-xs font-semibold text-emerald-600 mb-1 flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Financial Amounts</span>
      </div>
      <div class="flex flex-wrap gap-2">
        {snippet.financial_amounts.map(amount => (
          <div class="px-2 py-1 bg-emerald-50 border border-emerald-200 rounded text-xs font-mono text-emerald-800">
            {amount.amount} {amount.currency}
            {amount.context && (
              <span class="text-emerald-600 ml-1">({amount.context})</span>
            )}
          </div>
        ))}
      </div>
    </div>
  )}
</div>
