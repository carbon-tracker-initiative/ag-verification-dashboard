---
/**
 * Filters Bar Component
 * Allows filtering and sorting of questions by category, classification, and various metrics
 * Styled to align with the Dark Doppler aesthetic
 */

import categoriesConfig from '../../config/categories.json';

interface Props {
  categories: string[];
}

const { categories } = Astro.props;
---

<div class="surface sticky top-20 z-40 border border-slate-800/70 shadow-xl p-5">
  <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between w-full">
    <!-- Left Side: Filters -->
    <div class="flex flex-col lg:flex-row flex-wrap gap-3 flex-1 w-full">
      <div class="flex-1 min-w-[200px]">
        <label for="category-filter" class="block text-xs font-semibold text-slate-300 mb-1 uppercase tracking-wide">
          Category
        </label>
        <select
          id="category-filter"
          class="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent"
        >
          <option value="all">All Categories</option>
          {categoriesConfig.categories.map(cat => (
            <option value={cat.id}>{cat.name}</option>
          ))}
        </select>
      </div>

      <div class="flex-1 min-w-[200px]">
        <label for="classification-filter" class="block text-xs font-semibold text-slate-300 mb-1 uppercase tracking-wide">
          Classification
        </label>
        <select
          id="classification-filter"
          class="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent"
        >
          <option value="all">All Classifications</option>
          <option value="FULL_DISCLOSURE">Full Disclosure</option>
          <option value="PARTIAL">Partial</option>
          <option value="UNCLEAR">Unclear</option>
          <option value="NO_DISCLOSURE">No Disclosure</option>
        </select>
      </div>

      <div class="flex-1 min-w-[200px]">
        <label for="financial-filter" class="block text-xs font-semibold text-slate-300 mb-1 uppercase tracking-wide">
          Disclosure Type
        </label>
        <select
          id="financial-filter"
          class="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent"
        >
          <option value="all">All Disclosure Types</option>
          <option value="financial">Financial</option>
          <option value="partial-type">Partial-type</option>
          <option value="non-financial">Non-Financial</option>
        </select>
      </div>

      <div class="flex-1 min-w-[200px]">
        <label for="timeframe-filter" class="block text-xs font-semibold text-slate-300 mb-1 uppercase tracking-wide">
          Disclosure Timeframe
        </label>
        <select
          id="timeframe-filter"
          class="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent"
        >
          <option value="all">All Timeframes</option>
          <option value="present day">Present day</option>
          <option value="forward-looking">Forward-looking</option>
          <option value="backward-looking">Backward-looking</option>
          <option value="multiple or unclear">Multiple or Unclear</option>
        </select>
      </div>

      <div class="flex-1 min-w-[200px]">
        <label for="framing-filter" class="block text-xs font-semibold text-slate-300 mb-1 uppercase tracking-wide">
          Narrative Framing
        </label>
        <select
          id="framing-filter"
          class="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent"
        >
          <option value="all">All Framings</option>
          <option value="balanced">Balanced</option>
          <option value="opportunity">Opportunity</option>
          <option value="risk">Risk</option>
          <option value="neutral">Neutral</option>
        </select>
      </div>
    </div>

    <!-- Right Side: Sort and Actions -->
    <div class="flex gap-3 items-end">
      <div class="min-w-[180px]">
        <label for="sort-select" class="block text-xs font-semibold text-slate-300 mb-1 uppercase tracking-wide">
          Sort By
        </label>
        <select
          id="sort-select"
          class="w-full bg-slate-900/70 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent"
        >
          <option value="quality-desc">Quality (High to Low)</option>
          <option value="quality-asc">Quality (Low to High)</option>
          <option value="question-id">Question ID</option>
          <option value="evidence-desc">Evidence Count (High to Low)</option>
          <option value="evidence-asc">Evidence Count (Low to High)</option>
          <option value="financial-type">Disclosure Type</option>
          <option value="timeframe">Disclosure Timeframe</option>
          <option value="framing">Narrative Framing</option>
        </select>
      </div>

      <button
        id="reset-filters"
        class="px-4 py-2 text-sm font-medium text-slate-200 bg-slate-800/70 hover:bg-slate-700/80 rounded-lg transition-colors border border-slate-700"
        title="Reset all filters"
      >
        Reset
      </button>

      <button
        id="toggle-all"
        class="px-4 py-2 text-sm font-medium text-sky-200 bg-sky-600/20 hover:bg-sky-500/30 rounded-lg transition-colors border border-sky-500/40"
        title="Expand or collapse all questions"
      >
        Expand All
      </button>
    </div>
  </div>

  <div id="active-filters" class="mt-3 flex flex-wrap gap-2 hidden">
    <span class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Active Filters:</span>
  </div>

  <div id="results-count" class="mt-3 text-xs text-slate-400"></div>
</div>

<script>
  const collapsedIcon = '▸';
  const expandedIcon = '▾';

  function initFiltersBar() {
    const container = document.getElementById('questions-container');
    if (!(container instanceof HTMLElement)) {
      return;
    }

    const categoryFilter = document.getElementById('category-filter');
    const classificationFilter = document.getElementById('classification-filter');
    const financialFilter = document.getElementById('financial-filter');
    const timeframeFilter = document.getElementById('timeframe-filter');
    const framingFilter = document.getElementById('framing-filter');
    const sortSelect = document.getElementById('sort-select');
    const resetButton = document.getElementById('reset-filters');
    const toggleAllButton = document.getElementById('toggle-all');
    const activeFiltersDiv = document.getElementById('active-filters');
    const resultsCountDiv = document.getElementById('results-count');

    if (!(categoryFilter instanceof HTMLSelectElement) ||
        !(classificationFilter instanceof HTMLSelectElement) ||
        !(financialFilter instanceof HTMLSelectElement) ||
        !(timeframeFilter instanceof HTMLSelectElement) ||
        !(framingFilter instanceof HTMLSelectElement) ||
        !(sortSelect instanceof HTMLSelectElement) ||
        !(resetButton instanceof HTMLButtonElement) ||
        !(toggleAllButton instanceof HTMLButtonElement)) {
      return;
    }

    const questionNodes = Array.from(container.querySelectorAll('.question-card')).filter(
      (node) => node instanceof HTMLElement
    );

    let allExpanded = false;
    const totalQuestionCount = questionNodes.length;

    function setQuestionExpanded(card, expand) {
      if (!(card instanceof HTMLElement)) {
        return;
      }

      const content = card.querySelector('.question-content');
      const toggle = card.querySelector('.toggle-icon');
      const header = card.querySelector('.question-header');

      if (!(content instanceof HTMLElement) || !(toggle instanceof HTMLElement) || !(header instanceof HTMLElement)) {
        return;
      }

      if (expand) {
        content.hidden = false;
        content.classList.remove('hidden');
        content.removeAttribute('hidden');
        toggle.textContent = expandedIcon;
        toggle.classList.add('text-sky-300');
        toggle.classList.remove('text-slate-500');
        header.setAttribute('aria-expanded', 'true');
        card.classList.add('expanded');
      } else {
        content.hidden = true;
        content.classList.add('hidden');
        content.setAttribute('hidden', '');
        toggle.textContent = collapsedIcon;
        toggle.classList.remove('text-sky-300');
        toggle.classList.add('text-slate-500');
        header.setAttribute('aria-expanded', 'false');
        card.classList.remove('expanded');
      }
    }

    const financialOrder = ['financial', 'partial-type', 'non-financial', 'none'];
    const timeframeOrder = ['present day', 'forward-looking', 'backward-looking', 'multiple or unclear', 'none'];
    const framingOrder = ['balanced', 'opportunity', 'risk', 'neutral', 'none'];

    function compareByOrder(valueA, valueB, order) {
      const a = (valueA || 'none').toLowerCase();
      const b = (valueB || 'none').toLowerCase();
      const indexA = order.indexOf(a);
      const indexB = order.indexOf(b);
      const safeIndexA = indexA === -1 ? order.length : indexA;
      const safeIndexB = indexB === -1 ? order.length : indexB;

      if (safeIndexA !== safeIndexB) {
        return safeIndexA - safeIndexB;
      }

      return a.localeCompare(b);
    }

    function getComparator(sortValue) {
      switch (sortValue) {
        case 'quality-asc':
          return (a, b) => (parseFloat(a.dataset.score || '0') || 0) - (parseFloat(b.dataset.score || '0') || 0);
        case 'quality-desc':
          return (a, b) => (parseFloat(b.dataset.score || '0') || 0) - (parseFloat(a.dataset.score || '0') || 0);
        case 'evidence-asc':
          return (a, b) => (parseInt(a.dataset.snippets || '0', 10) || 0) - (parseInt(b.dataset.snippets || '0', 10) || 0);
        case 'evidence-desc':
          return (a, b) => (parseInt(b.dataset.snippets || '0', 10) || 0) - (parseInt(a.dataset.snippets || '0', 10) || 0);
        case 'question-id':
          return (a, b) => (a.dataset.questionId || '').localeCompare(b.dataset.questionId || '');
        case 'financial-type':
          return (a, b) => compareByOrder(a.dataset.primaryFinancial, b.dataset.primaryFinancial, financialOrder);
        case 'timeframe':
          return (a, b) => compareByOrder(a.dataset.primaryTimeframe, b.dataset.primaryTimeframe, timeframeOrder);
        case 'framing':
          return (a, b) => compareByOrder(a.dataset.primaryFraming, b.dataset.primaryFraming, framingOrder);
        default:
          return (a, b) => (parseFloat(b.dataset.score || '0') || 0) - (parseFloat(a.dataset.score || '0') || 0);
      }
    }

    function updateActiveFilters() {
      if (!(activeFiltersDiv instanceof HTMLElement)) {
        return;
      }

      const activeFilters = [];

      if (categoryFilter.value !== 'all') {
        activeFilters.push(`Category: ${categoryFilter.options[categoryFilter.selectedIndex].text}`);
      }
      if (classificationFilter.value !== 'all') {
        activeFilters.push(`Classification: ${classificationFilter.options[classificationFilter.selectedIndex].text}`);
      }
      if (financialFilter.value !== 'all') {
        activeFilters.push(`Disclosure Type: ${financialFilter.options[financialFilter.selectedIndex].text}`);
      }
      if (timeframeFilter.value !== 'all') {
        activeFilters.push(`Timeframe: ${timeframeFilter.options[timeframeFilter.selectedIndex].text}`);
      }
      if (framingFilter.value !== 'all') {
        activeFilters.push(`Framing: ${framingFilter.options[framingFilter.selectedIndex].text}`);
      }

      if (activeFilters.length > 0) {
        activeFiltersDiv.classList.remove('hidden');
        const tagsHTML = activeFilters
          .map(filter => `<span class="px-2 py-1 text-xs bg-sky-500/20 text-sky-200 rounded border border-sky-400/30">${filter}</span>`)
          .join('');
        activeFiltersDiv.innerHTML =
          '<span class="text-xs font-semibold text-slate-300 uppercase tracking-wide">Active Filters:</span>' + tagsHTML;
      } else {
        activeFiltersDiv.classList.add('hidden');
        activeFiltersDiv.innerHTML = '';
      }
    }

    function applyFiltersAndSort() {
      const categoryValue = categoryFilter.value;
      const classificationValue = classificationFilter.value;
      const financialValue = financialFilter.value;
      const timeframeValue = timeframeFilter.value;
      const framingValue = framingFilter.value;
      const sortValue = sortSelect.value;

      let visibleCount = 0;

      questionNodes.forEach(questionEl => {
        const matchesCategory = categoryValue === 'all' || questionEl.dataset.categoryId === categoryValue;
        const matchesClassification = classificationValue === 'all' || questionEl.dataset.classification === classificationValue;

        const questionFinancialTypes = (questionEl.dataset.financialTypes || '')
          .split('|')
          .map(value => value.trim().toLowerCase())
          .filter(Boolean);
        const questionTimeframes = (questionEl.dataset.timeframes || '')
          .split('|')
          .map(value => value.trim().toLowerCase())
          .filter(Boolean);
        const questionFramings = (questionEl.dataset.framings || '')
          .split('|')
          .map(value => value.trim().toLowerCase())
          .filter(Boolean);

        const matchesFinancial = financialValue === 'all' || questionFinancialTypes.includes(financialValue);
        const matchesTimeframe = timeframeValue === 'all' || questionTimeframes.includes(timeframeValue);
        const matchesFraming = framingValue === 'all' || questionFramings.includes(framingValue);

        const visible = matchesCategory && matchesClassification && matchesFinancial && matchesTimeframe && matchesFraming;

        if (visible) {
          questionEl.style.display = '';
          visibleCount += 1;
        } else {
          questionEl.style.display = 'none';
        }
      });

      const comparator = getComparator(sortValue);
      [...questionNodes].sort(comparator).forEach(node => container.appendChild(node));

      if (resultsCountDiv instanceof HTMLElement) {
        resultsCountDiv.textContent = `Showing ${visibleCount} of ${totalQuestionCount} questions`;
      }

      updateActiveFilters();

      allExpanded = questionNodes.every(card => {
        if (card.style.display === 'none' || card.dataset.expandable !== 'true') {
          return true;
        }
        return card.classList.contains('expanded');
      });

      toggleAllButton.textContent = allExpanded ? 'Collapse All' : 'Expand All';
    }

    function resetFilters() {
      categoryFilter.value = 'all';
      classificationFilter.value = 'all';
      financialFilter.value = 'all';
      timeframeFilter.value = 'all';
      framingFilter.value = 'all';
      sortSelect.value = 'quality-desc';
      applyFiltersAndSort();
    }

    function toggleAll() {
      allExpanded = !allExpanded;

      questionNodes.forEach(questionEl => {
        if (questionEl.style.display === 'none' || questionEl.dataset.expandable !== 'true') {
          return;
        }

        setQuestionExpanded(questionEl, allExpanded);
      });

      toggleAllButton.textContent = allExpanded ? 'Collapse All' : 'Expand All';
    }

    container.addEventListener('click', event => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }

      const header = target.closest('.question-header');
      if (!(header instanceof HTMLElement)) {
        return;
      }

      const card = header.closest('.question-card');
      if (!(card instanceof HTMLElement) || card.dataset.expandable !== 'true') {
        return;
      }

      if (target.closest('button')) {
        return;
      }

      const content = card.querySelector('.question-content');
      if (!(content instanceof HTMLElement)) {
        return;
      }

      const shouldExpand = content.classList.contains('hidden') || content.hasAttribute('hidden');
      setQuestionExpanded(card, shouldExpand);

      if (shouldExpand) {
        allExpanded = questionNodes.every(node => {
          if (node.style.display === 'none' || node.dataset.expandable !== 'true') {
            return true;
          }
          return node.classList.contains('expanded');
        });
      } else {
        allExpanded = false;
      }

      toggleAllButton.textContent = allExpanded ? 'Collapse All' : 'Expand All';
    });

    categoryFilter.addEventListener('change', applyFiltersAndSort);
    classificationFilter.addEventListener('change', applyFiltersAndSort);
    financialFilter.addEventListener('change', applyFiltersAndSort);
    timeframeFilter.addEventListener('change', applyFiltersAndSort);
    framingFilter.addEventListener('change', applyFiltersAndSort);
    sortSelect.addEventListener('change', applyFiltersAndSort);
    resetButton.addEventListener('click', resetFilters);
    toggleAllButton.addEventListener('click', toggleAll);

    applyFiltersAndSort();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFiltersBar);
  } else {
    initFiltersBar();
  }

  document.addEventListener('astro:page-load', initFiltersBar);
</script>

