---
/**
 * Question Accordion Component
 * Displays a single question with collapsible snippet cards
 */

import type { QuestionResult } from '../../types/analysis';
import type { QuestionMetrics } from '../../types/metrics';
import ClassificationBadge from '../shared/ClassificationBadge.astro';
import SnippetCard from './SnippetCard.astro';

interface Props {
  question: QuestionResult;
  metrics: QuestionMetrics;
  category: string;
  categoryIcon: string;
  categoryColor: string;
  categoryId: string;
  companyName: string;
  year: number;
}

const {
  question,
  metrics,
  category,
  categoryIcon,
  categoryColor,
  categoryId,
  companyName,
  year
} = Astro.props;

const bestClassificationSnippet = question.disclosures[0];
const bestClassification = question.disclosures.length > 0
  ? bestClassificationSnippet.classification
  : 'NO_DISCLOSURE';
const bestCollapsedLabel = (bestClassificationSnippet as any)?.collapsed_display;

const snippetCount = question.disclosures.length;
const isExpandable = snippetCount > 0;
const collapsedIcon = '>';
const expandedIcon = 'v';
const disabledIcon = '-';
const hasVerificationCorrection = question.disclosures.some(snippet => {
  const status = (snippet as any)?.comparison_status;
  return status === 'classification_corrected' || status === 'categorization_corrected';
});

const normalize = (value?: string) => (value || '').toLowerCase();

const financialTypesSet = new Set<string>();
const timeframesSet = new Set<string>();
const framingsSet = new Set<string>();

question.disclosures.forEach(snippet => {
  const financialType = normalize(snippet.categorization?.financial_type);
  const timeframe = normalize(snippet.categorization?.timeframe);
  const framing = normalize(snippet.categorization?.framing);

  if (financialType) financialTypesSet.add(financialType);
  if (timeframe) timeframesSet.add(timeframe);
  if (framing) framingsSet.add(framing);
});

const financialTypes = Array.from(financialTypesSet);
const timeframes = Array.from(timeframesSet);
const framings = Array.from(framingsSet);

const primarySnippet = question.disclosures[0];
const primaryFinancialType = normalize(primarySnippet?.categorization?.financial_type) || financialTypes[0] || 'none';
const primaryTimeframe = normalize(primarySnippet?.categorization?.timeframe) || timeframes[0] || 'none';
const primaryFraming = normalize(primarySnippet?.categorization?.framing) || framings[0] || 'none';

if (!financialTypes.length) financialTypes.push('none');
if (!timeframes.length) timeframes.push('none');
if (!framings.length) framings.push('none');
---

<div
  id={`question-${question.question_id}`}
  class="question-card surface transition-all"
  data-question-id={question.question_id}
  data-question-text={question.question_text}
  data-category={category}
  data-category-id={categoryId}
  data-classification={bestClassification}
  data-snippets={snippetCount}
  data-expandable={isExpandable ? 'true' : 'false'}
  data-financial-types={financialTypes.join('|')}
  data-timeframes={timeframes.join('|')}
  data-framings={framings.join('|')}
  data-primary-financial={primaryFinancialType}
  data-primary-timeframe={primaryTimeframe}
  data-primary-framing={primaryFraming}
>
  <div
    class="p-5 question-header flex items-start gap-4"
    class:list={{
      'cursor-pointer': isExpandable,
      'cursor-default opacity-80': !isExpandable
    }}
    data-question-id={question.question_id}
    data-question-text={question.question_text}
    aria-expanded="false"
  >
    <span class="toggle-icon text-slate-500 text-xl mt-1 flex-shrink-0 select-none">
      {isExpandable ? collapsedIcon : disabledIcon}
    </span>

    <div class="flex-1 min-w-0 space-y-3">
        <div class="flex items-start justify-between gap-5">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1 text-xs text-slate-400 uppercase tracking-wide">
            <span title={category} class="inline-flex items-center gap-1">
              <span>{categoryIcon}</span>
              <span>{category}</span>
            </span>
          </div>
          <h3 class="text-[17px] font-semibold text-slate-100 leading-snug">
            {question.question_text}
          </h3>
        </div>

        <div class="flex items-center gap-2">
          <ClassificationBadge
            classification={bestClassification}
            displayLabel={bestCollapsedLabel || undefined}
            size="lg"
          />
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3 text-xs text-slate-400">
        <span class="chip">
          <span class="font-semibold text-slate-200">Disclosures</span>
          <span>{snippetCount} disclosure{snippetCount === 1 ? '' : 's'}</span>
        </span>
        {!isExpandable && (
          <span class="chip chip-warning">
            No verified disclosure
          </span>
        )}
      </div>

      {question.merger_stats && (
        <div class="flex flex-wrap items-center gap-3 text-[11px] text-slate-500">
          <span>v3 {question.merger_stats.v3_snippets ?? 0}</span>
          <span>v4 {question.merger_stats.v4_snippets ?? 0}</span>
          <span>Merged {question.merger_stats.merged_snippets ?? 0}</span>
          {typeof question.merger_stats.ai_reviews_conducted !== 'undefined' && (
            <span>AI reviews {question.merger_stats.ai_reviews_conducted}</span>
          )}
          {typeof question.merger_stats.human_review_flagged !== 'undefined' && (
            <span>Human flags {question.merger_stats.human_review_flagged}</span>
          )}
        </div>
      )}

      {!isExpandable && (
        <div class="text-xs text-slate-500">
          No evidence disclosures were surfaced for this question.
        </div>
      )}
    </div>
  </div>

  {isExpandable && (
    <div class="question-content hidden" data-question-id={question.question_id} hidden>
      <div class="p-5 bg-slate-900/70 rounded-b-xl border-t border-slate-800 space-y-5">
        {question.summary && (
          <div class="p-4 bg-slate-900 rounded-lg border border-slate-800">
            <div class="text-xs font-semibold text-slate-300 uppercase tracking-wide mb-2">
              Summary Insight
            </div>
            <div class="text-sm text-slate-200 leading-relaxed">{question.summary}</div>
          </div>
        )}

        <div class="space-y-3">
          <div class="flex items-center gap-2 text-xs font-semibold text-slate-300 uppercase tracking-wide">
            Evidence Disclosures ({snippetCount})
            <span
              class="text-[12px] text-slate-400"
              title="Each disclosure is a verified statement linked to this question (FULL, PARTIAL, UNCLEAR, or NO_DISCLOSURE)."
              aria-label="Each disclosure is a verified statement linked to this question (FULL, PARTIAL, UNCLEAR, or NO_DISCLOSURE)."
            >
              â“˜
            </span>
          </div>

          {question.disclosures.map((snippet, index) => (
            <SnippetCard
              snippet={snippet}
              index={index + 1}
              company={companyName}
              year={year}
            />
          ))}
        </div>
      </div>
    </div>
  )}
</div>







