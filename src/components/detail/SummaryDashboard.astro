---
/**
 * Summary Dashboard Component
 * Displays overview metrics and visualization charts for a company-year analysis
 */

import type { CompanyMetrics } from '../../types/metrics';
import GradeDisplay from '../shared/GradeDisplay.astro';

interface Props {
  metrics: CompanyMetrics;
}

const { metrics } = Astro.props;

const averageSnippetsRounded = Math.max(
  0,
  Math.floor(metrics.average_snippets_per_question)
);

// Prepare chart data
const classificationData = {
  labels: ['Full Disclosure', 'Partial', 'Unclear', 'No Disclosure'],
  values: [
    metrics.snippets_by_classification['FULL_DISCLOSURE'] || 0,
    metrics.snippets_by_classification['PARTIAL'] || 0,
    metrics.snippets_by_classification['UNCLEAR'] || 0,
    metrics.snippets_by_classification['NO_DISCLOSURE'] || 0
  ],
  colors: ['#10b981', '#f59e0b', '#94a3b8', '#ef4444']
};

const financialData = {
  labels: ['Financial', 'Non-Financial'],
  values: [
    metrics.snippets_with_financial_full + metrics.snippets_with_financial_partial,
    metrics.snippets_with_financial_none
  ],
  percentages: [
    metrics.financial_quantification_rate,
    100 - metrics.financial_quantification_rate
  ]
};

const timeframeData = {
  labels: ['Present day', 'Forward-looking', 'Backward-looking', 'Multiple or Unclear'],
  values: [
    metrics.snippets_current,
    metrics.snippets_future,
    metrics.snippets_historical,
    metrics.snippets_unclear_time
  ]
};

const framingData = {
  labels: ['Risk', 'Opportunity', 'Both', 'Neutral'],
  values: [
    metrics.snippets_risk,
    metrics.snippets_opportunity,
    metrics.snippets_balanced,
    metrics.snippets_neutral
  ]
};
---

<div class="space-y-6">
  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Overall Score Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="text-sm font-semibold text-slate-600 mb-3">Overall Disclosure Quality</div>
      <GradeDisplay
        grade={metrics.overall_grade}
        score={metrics.overall_disclosure_score}
        size="large"
      />
      <div class="mt-4 text-xs text-slate-500">
        Based on {metrics.total_snippets} snippets across {metrics.total_questions_analyzed} questions
      </div>
    </div>
    <!-- Evidence Stats Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="text-sm font-semibold text-slate-600 mb-3">Evidence Statistics</div>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-600">Total Snippets</span>
          <span class="text-lg font-bold text-slate-800">{metrics.total_snippets}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-600">Avg per Question</span>
          <span class="text-lg font-bold text-slate-800">
            {averageSnippetsRounded}
          </span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-600">With Financial Data</span>
          <span class="text-lg font-bold text-emerald-600">
            {metrics.snippets_with_financial_full + metrics.snippets_with_financial_partial}
          </span>
        </div>
      </div>
    </div>

    <!-- Category Breakdown Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="text-sm font-semibold text-slate-600 mb-3">Top Category</div>
      {Object.entries(metrics.category_scores)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 1)
        .map(([category, score]) => (
          <div>
            <div class="text-xl font-bold text-blue-600 mb-2">
              {category}
            </div>
            <div class="flex items-center gap-2 mb-3">
              <div class="text-2xl font-bold text-slate-800">{score.toFixed(1)}%</div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
              <div
                class="bg-blue-600 h-2 rounded-full transition-all"
                style={`width: ${score}%`}
              ></div>
            </div>
          </div>
        ))
      }
      <div class="mt-4 text-xs text-slate-500">
        View all categories below
      </div>
    </div>
  </div>

  <!-- Visualization Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Classification Distribution Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Classification Distribution</h3>
        <div class="flex items-center gap-6">
          <div class="flex-shrink-0">
            <canvas
              id="classification-chart"
              width="180"
              height="180"
              data-full={classificationData.values[0]}
              data-partial={classificationData.values[1]}
              data-unclear={classificationData.values[2]}
              data-none={classificationData.values[3]}
            ></canvas>
          </div>
        <div class="flex-1 space-y-2">
          {classificationData.labels.map((label, i) => (
            <div class="flex items-center justify-between text-xs">
              <div class="flex items-center gap-2">
                <div
                  class="w-3 h-3 rounded-full"
                  style={`background-color: ${classificationData.colors[i]}`}
                ></div>
                <span class="text-slate-600">{label}</span>
              </div>
              <span class="font-semibold text-slate-800">{classificationData.values[i]}</span>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Financial Disclosure Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Financial Disclosure Rate</h3>
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-2xl font-bold text-emerald-600">
            {financialData.percentages[0].toFixed(1)}%
          </span>
          <span class="text-xs text-slate-500">
            {financialData.values[0]} of {metrics.total_snippets} snippets
          </span>
        </div>
        <div class="space-y-2">
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs text-slate-600">With Financial Amounts</span>
              <span class="text-xs font-semibold text-emerald-600">
                {financialData.percentages[0].toFixed(0)}%
              </span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-3">
              <div
                class="bg-emerald-500 h-3 rounded-full transition-all"
                style={`width: ${financialData.percentages[0]}%`}
              ></div>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs text-slate-600">Non-Financial Only</span>
              <span class="text-xs font-semibold text-slate-600">
                {financialData.percentages[1].toFixed(0)}%
              </span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-3">
              <div
                class="bg-slate-400 h-3 rounded-full transition-all"
                style={`width: ${financialData.percentages[1]}%`}
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeframe Distribution Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Temporal Specificity</h3>
      <div class="space-y-2">
        {timeframeData.labels.map((label, i) => {
          const percentage = (timeframeData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#94a3b8'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-600">{label}</span>
                <span class="text-xs font-semibold text-slate-800">
                  {timeframeData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-200 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <!-- Narrative Framing Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Narrative Framing</h3>
      <div class="space-y-2">
        {framingData.labels.map((label, i) => {
          const percentage = (framingData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#ef4444', '#10b981', '#f59e0b', '#6b7280'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-600">{label}</span>
                <span class="text-xs font-semibold text-slate-800">
                  {framingData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-200 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Script for Donut Chart -->
<script>
  function drawClassificationChart() {
    const canvasEl = document.getElementById('classification-chart');
    if (!(canvasEl instanceof HTMLCanvasElement)) {
      return;
    }

    const ctx = canvasEl.getContext('2d');
    if (!ctx) return;

    const segments = [
      { value: Number(canvasEl.dataset.full || '0'), color: '#10b981' },
      { value: Number(canvasEl.dataset.partial || '0'), color: '#f59e0b' },
      { value: Number(canvasEl.dataset.unclear || '0'), color: '#94a3b8' },
      { value: Number(canvasEl.dataset.none || '0'), color: '#ef4444' }
    ];

    const total = segments.reduce((sum, segment) => {
      const value = Number.isFinite(segment.value) ? segment.value : 0;
      return sum + value;
    }, 0);

    ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);

    if (total <= 0) {
      return;
    }

    let currentAngle = -Math.PI / 2;

    segments.forEach(({ value, color }) => {
      if (value <= 0) {
        return;
      }

      const sliceAngle = (value / total) * 2 * Math.PI;

      ctx.beginPath();
      ctx.arc(canvasEl.width / 2, canvasEl.height / 2, 70, currentAngle, currentAngle + sliceAngle);
      ctx.arc(canvasEl.width / 2, canvasEl.height / 2, 35, currentAngle + sliceAngle, currentAngle, true);
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();

      currentAngle += sliceAngle;
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', drawClassificationChart);
  } else {
    drawClassificationChart();
  }

  document.addEventListener('astro:page-load', drawClassificationChart);
</script>



