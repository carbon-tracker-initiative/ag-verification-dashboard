---
/**
 * Summary Dashboard Component
 * Collapsed disclosure view: only Disclosure vs No Disclosure
 */

import type { CompanyMetrics } from '../../types/metrics';

interface Props {
  metrics: CompanyMetrics;
  totalPages?: number;
}

const { metrics, totalPages } = Astro.props;

const averageSnippetsRounded = Math.max(
  0,
  Math.floor(metrics.average_snippets_per_question)
);

const totalPagesDisplay = typeof totalPages === 'number'
  ? new Intl.NumberFormat('en-US').format(totalPages)
  : null;

const disclosureCount =
  (metrics.snippets_by_classification['FULL_DISCLOSURE'] || 0) +
  (metrics.snippets_by_classification['PARTIAL'] || 0);
const noDisclosureCount =
  (metrics.snippets_by_classification['NO_DISCLOSURE'] || 0) +
  (metrics.snippets_by_classification['UNCLEAR'] || 0);
const totalSnippets = metrics.total_snippets || 0;
const disclosurePct = totalSnippets ? (disclosureCount / totalSnippets) * 100 : 0;
const noDisclosurePct = totalSnippets ? (noDisclosureCount / totalSnippets) * 100 : 0;

const financialData = {
  labels: ['Financial', 'Non-Financial'],
  values: [
    metrics.snippets_with_financial_full + metrics.snippets_with_financial_partial,
    metrics.snippets_with_financial_none
  ],
  percentages: [
    metrics.financial_quantification_rate,
    100 - metrics.financial_quantification_rate
  ]
};

const timeframeData = {
  labels: ['Present day', 'Forward-looking', 'Backward-looking', 'Multiple or Unclear'],
  values: [
    metrics.snippets_current,
    metrics.snippets_future,
    metrics.snippets_historical,
    metrics.snippets_unclear_time
  ]
};

const framingData = {
  labels: ['Risk', 'Opportunity', 'Both', 'Neutral'],
  values: [
    metrics.snippets_risk,
    metrics.snippets_opportunity,
    metrics.snippets_balanced,
    metrics.snippets_neutral
  ]
};
---

<div class="space-y-6">
  <!-- Disclosure Analysis -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="surface border border-slate-800 p-6 rounded-xl">
      <h3 class="flex items-center gap-2 text-sm font-semibold text-slate-200 mb-4">
        Risk Disclosure Time Horizon
        <span
          class="text-[12px] text-slate-400"
          title="Backward-looking: Refers exclusively to completed past events. Present day: Activities or risks ongoing as of reporting date. Forward-looking: Anticipated future risks or events not yet manifested. Multiple/Unclear: Ambiguous timeframe or spans multiple periods."
          aria-label="Backward-looking: Refers exclusively to completed past events. Present day: Activities or risks ongoing as of reporting date. Forward-looking: Anticipated future risks or events not yet manifested. Multiple/Unclear: Ambiguous timeframe or spans multiple periods."
        >
          ⓘ
        </span>
      </h3>
      <div class="space-y-2">
        {timeframeData.labels.map((label, i) => {
          const percentage = (timeframeData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#94a3b8'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-400">{label}</span>
                <span class="text-xs font-semibold text-slate-200">
                  {timeframeData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-800 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <div class="surface border border-slate-800 p-6 rounded-xl">
      <h3 class="flex items-center gap-2 text-sm font-semibold text-slate-200 mb-4">
        Risk Disclosure Framing
        <span
          class="text-[12px] text-slate-400"
          title="Risk: Presents topic as source of harm, uncertainty, or negative consequences. Opportunity: Frames topic as beneficial or value-creating for the business. Neutral: Factual or informational content without evaluative framing. Both: Discusses risks and opportunities together."
          aria-label="Risk: Presents topic as source of harm, uncertainty, or negative consequences. Opportunity: Frames topic as beneficial or value-creating for the business. Neutral: Factual or informational content without evaluative framing. Both: Discusses risks and opportunities together."
        >
          ⓘ
        </span>
      </h3>
      <div class="space-y-2">
        {framingData.labels.map((label, i) => {
          const percentage = (framingData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#ef4444', '#10b981', '#f59e0b', '#6b7280'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-400">{label}</span>
                <span class="text-xs font-semibold text-slate-200">
                  {framingData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-800 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
</div>
