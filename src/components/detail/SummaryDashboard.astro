---
/**
 * Summary Dashboard Component
 * Displays overview metrics and visualization charts for a company-year analysis
 */

import type { CompanyMetrics } from '../../types/metrics';
import GradeDisplay from '../shared/GradeDisplay.astro';

interface Props {
  metrics: CompanyMetrics;
}

const { metrics } = Astro.props;

// Prepare chart data
const classificationData = {
  labels: ['Full Disclosure', 'Partial', 'Unclear', 'No Disclosure'],
  values: [
    metrics.full_disclosure_count,
    metrics.partial_disclosure_count,
    metrics.unclear_count,
    metrics.no_disclosure_count
  ],
  colors: ['#10b981', '#f59e0b', '#94a3b8', '#ef4444']
};

const financialData = {
  labels: ['Financial', 'Non-Financial'],
  values: [
    metrics.questions_with_financial,
    metrics.total_questions - metrics.questions_with_financial
  ],
  percentages: [
    metrics.financial_quantification_rate,
    100 - metrics.financial_quantification_rate
  ]
};

const timeframeData = {
  labels: ['Current', 'Future', 'Historical', 'Unclear'],
  values: [
    metrics.radar_metrics.temporal_specificity.current_focus,
    metrics.radar_metrics.temporal_specificity.forward_looking,
    metrics.radar_metrics.temporal_specificity.historical,
    metrics.total_snippets - (
      metrics.radar_metrics.temporal_specificity.current_focus +
      metrics.radar_metrics.temporal_specificity.forward_looking +
      metrics.radar_metrics.temporal_specificity.historical
    )
  ]
};

const framingData = {
  labels: ['Risk', 'Opportunity', 'Both', 'Neutral'],
  values: [
    metrics.radar_metrics.narrative_balance.risk_focused,
    metrics.radar_metrics.narrative_balance.opportunity_focused,
    metrics.radar_metrics.narrative_balance.balanced,
    metrics.total_snippets - (
      metrics.radar_metrics.narrative_balance.risk_focused +
      metrics.radar_metrics.narrative_balance.opportunity_focused +
      metrics.radar_metrics.narrative_balance.balanced
    )
  ]
};
---

<div class="space-y-6">
  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Overall Score Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="text-sm font-semibold text-slate-600 mb-3">Overall Disclosure Quality</div>
      <GradeDisplay
        grade={metrics.overall_grade}
        score={metrics.overall_disclosure_score}
        size="large"
      />
      <div class="mt-4 text-xs text-slate-500">
        Based on {metrics.total_snippets} snippets across {metrics.total_questions} questions
      </div>
    </div>

    <!-- Evidence Stats Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="text-sm font-semibold text-slate-600 mb-3">Evidence Statistics</div>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-600">Total Snippets</span>
          <span class="text-lg font-bold text-slate-800">{metrics.total_snippets}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-600">Avg per Question</span>
          <span class="text-lg font-bold text-slate-800">
            {(metrics.total_snippets / metrics.total_questions).toFixed(1)}
          </span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-600">With Financial Data</span>
          <span class="text-lg font-bold text-emerald-600">
            {metrics.questions_with_financial}
          </span>
        </div>
      </div>
    </div>

    <!-- Category Breakdown Card -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <div class="text-sm font-semibold text-slate-600 mb-3">Top Category</div>
      {Object.entries(metrics.category_scores)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 1)
        .map(([category, score]) => (
          <div>
            <div class="text-xl font-bold text-blue-600 mb-2">
              {category}
            </div>
            <div class="flex items-center gap-2 mb-3">
              <div class="text-2xl font-bold text-slate-800">{score.toFixed(1)}%</div>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-2">
              <div
                class="bg-blue-600 h-2 rounded-full transition-all"
                style={`width: ${score}%`}
              ></div>
            </div>
          </div>
        ))
      }
      <div class="mt-4 text-xs text-slate-500">
        View all categories below
      </div>
    </div>
  </div>

  <!-- Visualization Charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Classification Distribution Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Classification Distribution</h3>
      <div class="flex items-center gap-6">
        <div class="flex-shrink-0">
          <canvas id="classification-chart" width="180" height="180"></canvas>
        </div>
        <div class="flex-1 space-y-2">
          {classificationData.labels.map((label, i) => (
            <div class="flex items-center justify-between text-xs">
              <div class="flex items-center gap-2">
                <div
                  class="w-3 h-3 rounded-full"
                  style={`background-color: ${classificationData.colors[i]}`}
                ></div>
                <span class="text-slate-600">{label}</span>
              </div>
              <span class="font-semibold text-slate-800">{classificationData.values[i]}</span>
            </div>
          ))}
        </div>
      </div>
    </div>

    <!-- Financial Disclosure Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Financial Disclosure Rate</h3>
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <span class="text-2xl font-bold text-emerald-600">
            {financialData.percentages[0].toFixed(1)}%
          </span>
          <span class="text-xs text-slate-500">
            {financialData.values[0]} of {metrics.total_questions} questions
          </span>
        </div>
        <div class="space-y-2">
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs text-slate-600">With Financial Amounts</span>
              <span class="text-xs font-semibold text-emerald-600">
                {financialData.percentages[0].toFixed(0)}%
              </span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-3">
              <div
                class="bg-emerald-500 h-3 rounded-full transition-all"
                style={`width: ${financialData.percentages[0]}%`}
              ></div>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1">
              <span class="text-xs text-slate-600">Non-Financial Only</span>
              <span class="text-xs font-semibold text-slate-600">
                {financialData.percentages[1].toFixed(0)}%
              </span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-3">
              <div
                class="bg-slate-400 h-3 rounded-full transition-all"
                style={`width: ${financialData.percentages[1]}%`}
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeframe Distribution Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Temporal Specificity</h3>
      <div class="space-y-2">
        {timeframeData.labels.map((label, i) => {
          const percentage = (timeframeData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#94a3b8'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-600">{label}</span>
                <span class="text-xs font-semibold text-slate-800">
                  {timeframeData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-200 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <!-- Narrative Framing Chart -->
    <div class="bg-white rounded-lg shadow-sm p-6 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-4">Narrative Framing</h3>
      <div class="space-y-2">
        {framingData.labels.map((label, i) => {
          const percentage = (framingData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#ef4444', '#10b981', '#f59e0b', '#6b7280'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-600">{label}</span>
                <span class="text-xs font-semibold text-slate-800">
                  {framingData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-200 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js Script for Donut Chart -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('classification-chart') as HTMLCanvasElement;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Get data from the rendered component
    const data = {
      labels: ['Full Disclosure', 'Partial', 'Unclear', 'No Disclosure'],
      datasets: [{
        data: [
          parseInt(canvas.dataset.full || '0'),
          parseInt(canvas.dataset.partial || '0'),
          parseInt(canvas.dataset.unclear || '0'),
          parseInt(canvas.dataset.none || '0')
        ],
        backgroundColor: ['#10b981', '#f59e0b', '#94a3b8', '#ef4444'],
        borderWidth: 0
      }]
    };

    // Simple donut chart implementation
    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
    let currentAngle = -Math.PI / 2;

    data.datasets[0].data.forEach((value, i) => {
      const sliceAngle = (value / total) * 2 * Math.PI;

      ctx.beginPath();
      ctx.arc(90, 90, 70, currentAngle, currentAngle + sliceAngle);
      ctx.arc(90, 90, 35, currentAngle + sliceAngle, currentAngle, true);
      ctx.closePath();
      ctx.fillStyle = data.datasets[0].backgroundColor[i];
      ctx.fill();

      currentAngle += sliceAngle;
    });
  });
</script>

<canvas
  id="classification-chart"
  data-full={metrics.full_disclosure_count}
  data-partial={metrics.partial_disclosure_count}
  data-unclear={metrics.unclear_count}
  data-none={metrics.no_disclosure_count}
  class="hidden"
></canvas>
