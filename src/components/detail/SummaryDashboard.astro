---
/**
 * Summary Dashboard Component
 * Collapsed disclosure view: only Disclosure vs No Disclosure
 */

import type { CompanyMetrics } from '../../types/metrics';

interface Props {
  metrics: CompanyMetrics;
  totalPages?: number;
}

const { metrics, totalPages } = Astro.props;

const averageSnippetsRounded = Math.max(
  0,
  Math.floor(metrics.average_snippets_per_question)
);

const totalPagesDisplay = typeof totalPages === 'number'
  ? new Intl.NumberFormat('en-US').format(totalPages)
  : null;

const disclosureCount =
  (metrics.snippets_by_classification['FULL_DISCLOSURE'] || 0) +
  (metrics.snippets_by_classification['PARTIAL'] || 0);
const noDisclosureCount =
  (metrics.snippets_by_classification['NO_DISCLOSURE'] || 0) +
  (metrics.snippets_by_classification['UNCLEAR'] || 0);
const totalSnippets = metrics.total_snippets || 0;
const disclosurePct = totalSnippets ? (disclosureCount / totalSnippets) * 100 : 0;
const noDisclosurePct = totalSnippets ? (noDisclosureCount / totalSnippets) * 100 : 0;

const financialData = {
  labels: ['Financial', 'Non-Financial'],
  values: [
    metrics.snippets_with_financial_full + metrics.snippets_with_financial_partial,
    metrics.snippets_with_financial_none
  ],
  percentages: [
    metrics.financial_quantification_rate,
    100 - metrics.financial_quantification_rate
  ]
};

const timeframeData = {
  labels: ['Present day', 'Forward-looking', 'Backward-looking', 'Multiple or Unclear'],
  values: [
    metrics.snippets_current,
    metrics.snippets_future,
    metrics.snippets_historical,
    metrics.snippets_unclear_time
  ]
};

const framingData = {
  labels: ['Risk', 'Opportunity', 'Both', 'Neutral'],
  values: [
    metrics.snippets_risk,
    metrics.snippets_opportunity,
    metrics.snippets_balanced,
    metrics.snippets_neutral
  ]
};
---

<div class="space-y-6">
  <!-- Summary row -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="surface border border-slate-800 p-6 rounded-xl">
      <div class="text-sm font-semibold text-slate-200 mb-3">Evidence Statistics</div>
      <div class="space-y-3 text-slate-100">
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-400">Total snippets</span>
          <span class="text-lg font-bold">{metrics.total_snippets}</span>
        </div>
        {totalPagesDisplay && (
          <div class="flex items-center justify-between">
            <span class="text-xs text-slate-400">Source pages</span>
            <span class="text-sm font-semibold text-slate-200">{totalPagesDisplay}</span>
          </div>
        )}
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-400">Avg per question</span>
          <span class="text-lg font-bold">{averageSnippetsRounded}</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-xs text-slate-400">With financial data</span>
          <span class="text-lg font-bold text-emerald-300">
            {metrics.snippets_with_financial_full + metrics.snippets_with_financial_partial}
          </span>
        </div>
      </div>
    </div>

    <div class="surface border border-slate-800 p-6 rounded-xl">
      <div class="text-sm font-semibold text-slate-200 mb-4">Classification (collapsed)</div>
      <div class="space-y-3">
        <div class="flex items-center justify-between text-xs text-slate-300">
          <span class="font-semibold text-emerald-200">Disclosure</span>
          <span>{disclosureCount} ({disclosurePct.toFixed(0)}%)</span>
        </div>
        <div class="w-full bg-slate-800 rounded-full h-3">
          <div
            class="h-3 rounded-full bg-emerald-400 transition-all"
            style={`width: ${disclosurePct}%`}
          ></div>
        </div>
        <div class="flex items-center justify-between text-xs text-slate-300">
          <span class="font-semibold text-slate-200">No disclosure</span>
          <span>{noDisclosureCount} ({noDisclosurePct.toFixed(0)}%)</span>
        </div>
        <div class="w-full bg-slate-800 rounded-full h-3">
          <div
            class="h-3 rounded-full bg-slate-500 transition-all"
            style={`width: ${noDisclosurePct}%`}
          ></div>
        </div>
      </div>
    </div>

    <div class="surface border border-slate-800 p-6 rounded-xl">
      <div class="text-sm font-semibold text-slate-200 mb-4">Financial Disclosure Rate</div>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <span class="text-2xl font-bold text-emerald-300">
            {financialData.percentages[0].toFixed(1)}%
          </span>
          <span class="text-xs text-slate-400">
            {financialData.values[0]} of {metrics.total_snippets} snippets
          </span>
        </div>
        <div>
          <div class="flex items-center justify-between mb-1 text-xs text-slate-400">
            <span>With financial amounts</span>
            <span class="text-emerald-300 font-semibold">{financialData.percentages[0].toFixed(0)}%</span>
          </div>
          <div class="w-full bg-slate-800 rounded-full h-3">
            <div
              class="h-3 rounded-full bg-emerald-400 transition-all"
              style={`width: ${financialData.percentages[0]}%`}
            ></div>
          </div>
        </div>
        <div>
          <div class="flex items-center justify-between mb-1 text-xs text-slate-400">
            <span>Non-financial only</span>
            <span class="font-semibold">{financialData.percentages[1].toFixed(0)}%</span>
          </div>
          <div class="w-full bg-slate-800 rounded-full h-3">
            <div
              class="h-3 rounded-full bg-slate-500 transition-all"
              style={`width: ${financialData.percentages[1]}%`}
            ></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional charts -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="surface border border-slate-800 p-6 rounded-xl">
      <h3 class="text-sm font-semibold text-slate-200 mb-4">Temporal Specificity</h3>
      <div class="space-y-2">
        {timeframeData.labels.map((label, i) => {
          const percentage = (timeframeData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#94a3b8'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-400">{label}</span>
                <span class="text-xs font-semibold text-slate-200">
                  {timeframeData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-800 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <div class="surface border border-slate-800 p-6 rounded-xl">
      <h3 class="text-sm font-semibold text-slate-200 mb-4">Narrative Framing</h3>
      <div class="space-y-2">
        {framingData.labels.map((label, i) => {
          const percentage = (framingData.values[i] / metrics.total_snippets) * 100;
          const colors = ['#ef4444', '#10b981', '#f59e0b', '#6b7280'];
          return (
            <div>
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-slate-400">{label}</span>
                <span class="text-xs font-semibold text-slate-200">
                  {framingData.values[i]} ({percentage.toFixed(0)}%)
                </span>
              </div>
              <div class="w-full bg-slate-800 rounded-full h-2">
                <div
                  class="h-2 rounded-full transition-all"
                  style={`width: ${percentage}%; background-color: ${colors[i]}`}
                ></div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  </div>
</div>
