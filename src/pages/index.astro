---
/**
 * Home page - Verification Dashboard
 * Displays overview of all companies with verified analysis results
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import HeroSection from '../components/home/HeroSection.astro';
import CategoryCard from '../components/home/CategoryCard.astro';
import QuestionRankings from '../components/home/QuestionRankings.astro';

import { loadAllCompanyData } from '../utils/dataLoader';
import { calculateCompanyMetrics, calculateCrossCompanyMetrics, calculateCategoryMetrics } from '../utils/metricsCalculator';

// Get sort parameter from URL
const url = new URL(Astro.request.url);
const sortBy = (url.searchParams.get('sort') as 'quality' | 'question_id' | 'evidence_count') || 'quality';

// Load all company data
const allCompanyData = await loadAllCompanyData();

// Calculate metrics for each company
const companyMetrics = allCompanyData.map(data =>
  calculateCompanyMetrics(data.verified)
);

// Create enriched data with version info
const enrichedCompanyData = allCompanyData.map((data, index) => ({
  data,
  metrics: companyMetrics[index]
}));

// Calculate cross-company metrics
const crossCompanyMetrics = calculateCrossCompanyMetrics(companyMetrics, allCompanyData);

// Get unique categories from all companies
const allCategories = new Set<string>();
allCompanyData.forEach(data => {
  data.verified.analysis_results.forEach(q => allCategories.add(q.category));
});

// Calculate category metrics across all companies
const categoryMetrics = Array.from(allCategories).map(categoryName => {
  // Collect all questions from all companies for this category
  const allQuestionsInCategory = allCompanyData.flatMap(data =>
    data.verified.analysis_results.filter(q => q.category === categoryName)
  );

  return calculateCategoryMetrics(allQuestionsInCategory, categoryName);
});

const normalizedBaseUrl = (import.meta.env.BASE_URL || '').replace(/\/$/, '');
// Build question-to-company disclosure counts (excluding NO_DISCLOSURE)
const questionMap = new Map<string, { question_id: string; question_text: string; companyCounts: Array<{ label: string; href: string; count: number }> }>();

enrichedCompanyData.forEach(({ data }) => {
  const companyLabel = `${data.company} (${data.year}, ${data.version})`;
  const href = `${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`;

  data.verified.analysis_results.forEach(question => {
    const disclosures = Array.isArray(question.disclosures) ? question.disclosures : [];
    const counted = disclosures.filter(d => d.classification !== 'NO_DISCLOSURE').length;

    if (!questionMap.has(question.question_id)) {
      questionMap.set(question.question_id, {
        question_id: question.question_id,
        question_text: question.question_text,
        companyCounts: []
      });
    }
    questionMap.get(question.question_id)!.companyCounts.push({
      label: companyLabel,
      href,
      count: counted
    });
  });
});

const questionOptions = Array.from(questionMap.values()).sort((a, b) => a.question_id.localeCompare(b.question_id));
const selectedQuestionId = url.searchParams.get('question') || '99901';

// Function to strip common prefix from question text for dropdown display
function stripQuestionPrefix(text: string): string {
  return text
    .replace(/^Does the company disclose whether it thinks that /i, '')
    .replace(/^Does the company disclose whether it thinks /i, '')
    .replace(/^Does the company disclose that /i, '')
    .replace(/^Does the company disclose /i, '');
}

const chartPayload = questionOptions.map(q => ({
  question_id: q.question_id,
  question_text: q.question_text,
  companyCounts: q.companyCounts.sort((a, b) => b.count - a.count)
}));
---

<Layout title="Verification Dashboard - Home">
  <Header currentPath="/" />

  <main class="min-h-screen">
    <!-- Hero Section with Global Stats -->
    <HeroSection globalStats={crossCompanyMetrics.global_stats} />

    <!-- Company Navigation -->
    <div class="border-b border-slate-800 bg-slate-950/70 py-8">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <label for="company-selector" class="text-lg font-semibold text-slate-100">
            Go directly to a company of your interest
          </label>
          <select
            id="company-selector"
            class="w-full sm:w-96 rounded-md border border-slate-700 bg-slate-900/70 px-4 py-3 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="">Select a company...</option>
            {enrichedCompanyData
              .sort((a, b) => a.data.company.localeCompare(b.data.company))
              .map(({ data }) => (
                <option value={`${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`}>
                  {data.company} - {data.year} ({data.version})
                </option>
              ))}
          </select>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Question-based cross-company disclosure chart -->
      <section class="mb-12">
        <div class="mb-4">
          <h2 class="text-2xl font-bold text-slate-100 mb-2">Cross-company disclosures by question</h2>
          <p class="text-sm text-slate-400 mb-3">Select a risk question to compare total disclosures across companies.</p>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:flex-wrap">
            <label for="question-selector" class="text-sm font-medium text-slate-300 whitespace-nowrap">
              Choose a question/risk: <span class="text-slate-400">Does the company disclose whether it thinks</span>
            </label>
            <select
              id="question-selector"
              class="flex-1 min-w-0 rounded-md border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
            >
              {questionOptions.map(option => (
                <option value={option.question_id} selected={option.question_id === selectedQuestionId}>
                  {stripQuestionPrefix(option.question_text)}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div class="mb-3">
          <h3 id="question-title" class="text-lg font-semibold text-sky-400">Does the company disclose...</h3>
        </div>

        <div class="surface border border-slate-800 p-4 sm:p-6 rounded-xl">
          <div class="flex items-center gap-2 text-sm text-slate-500 mb-3">
            <span class="w-3 h-3 rounded-full" style="background-color: #10b981;"></span>
            <span class="text-emerald-400 font-medium">Total disclosures</span>
          </div>
          <div id="question-chart" class="flex items-end justify-around gap-2 h-96 px-4">
            <!-- Bars will be rendered here via JavaScript -->
          </div>
        </div>
      </section>

      <!-- Question Rankings -->
      <QuestionRankings
        questionRankings={crossCompanyMetrics.question_rankings}
        sortBy={sortBy}
      />

      <!-- Category Performance Overview -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Risk Category Performance</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          {categoryMetrics
            .sort((a, b) => b.average_question_score - a.average_question_score)
            .map(category => (
              <CategoryCard category={category} expandable={true} />
            ))}
        </div>
      </section>
    </div>
  </main>

  <script define:vars={{ chartPayload, selectedQuestionId }}>
    const chartContainer = document.getElementById('question-chart');
    const selectEl = document.getElementById('question-selector');
    const questionTitle = document.getElementById('question-title');

    function updateQuestionTitle(questionId) {
      const questionData = chartPayload.find(q => q.question_id === questionId);
      if (!questionData || !questionTitle) return;

      // Show full question text in title
      questionTitle.textContent = questionData.question_text;
    }

    function getShortQuestionText(fullText) {
      // Remove "Does the company disclose whether it thinks" from the beginning
      return fullText
        .replace(/^Does the company disclose whether it thinks that /i, '')
        .replace(/^Does the company disclose whether it thinks /i, '')
        .replace(/^Does the company disclose that /i, '')
        .replace(/^Does the company disclose /i, '');
    }

    function renderBars(questionId) {
      const questionData = chartPayload.find(q => q.question_id === questionId);
      if (!questionData || !chartContainer) return;

      // Update question title
      updateQuestionTitle(questionId);

      // Create a map for quick lookup of counts by company label
      const countMap = new Map(questionData.companyCounts.map(c => [c.label, c]));

      // Get all unique companies from all questions and sort alphabetically
      const allCompanies = new Set();
      chartPayload.forEach(q => {
        q.companyCounts.forEach(c => allCompanies.add(c.label));
      });
      const sortedCompanies = Array.from(allCompanies).sort((a, b) => a.localeCompare(b));

      // Find max value for scaling across all companies
      const allCounts = sortedCompanies.map(label => countMap.get(label)?.count || 0);
      const maxCount = Math.max(...allCounts, 1);
      const maxHeightPx = 320; // Max height in pixels

      // If bars already exist, update their heights with transition
      const existingBars = chartContainer.querySelectorAll('.chart-bar');
      if (existingBars.length === sortedCompanies.length) {
        sortedCompanies.forEach((companyLabel, index) => {
          const companyData = countMap.get(companyLabel);
          const count = companyData?.count || 0;
          const heightPx = Math.max(5, (count / maxCount) * maxHeightPx);

          const bar = existingBars[index];
          const countElem = bar.parentElement.querySelector('.bar-count');

          bar.style.height = `${heightPx}px`;
          if (countElem) countElem.textContent = count;
        });
        return;
      }

      // Clear and create new bars
      chartContainer.innerHTML = '';

      // Create vertical bars for ALL companies
      sortedCompanies.forEach(companyLabel => {
        const companyData = countMap.get(companyLabel);
        const count = companyData?.count || 0;
        const href = companyData?.href || '#';

        // Calculate height in pixels with minimum of 5px for visibility
        const heightPx = Math.max(5, (count / maxCount) * maxHeightPx);

        // Extract just company name (remove year and team-reviewed)
        const companyName = companyLabel.split('(')[0].trim();

        const barWrapper = document.createElement('div');
        barWrapper.className = 'bar-wrapper flex flex-col-reverse items-center gap-1 flex-1 min-w-0 cursor-pointer';
        if (companyData) {
          barWrapper.onclick = () => window.location.href = href;
        }

        const bar = document.createElement('div');
        bar.className = 'chart-bar w-full rounded-t shadow-lg';
        bar.style.height = `${heightPx}px`;
        bar.style.background = 'linear-gradient(180deg, #10b981 0%, #059669 100%)';
        bar.style.minHeight = '5px';
        bar.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        bar.style.boxShadow = '0 4px 6px -1px rgba(16, 185, 129, 0.3), 0 2px 4px -1px rgba(16, 185, 129, 0.2)';
        bar.title = `${companyName}: ${count} disclosure${count === 1 ? '' : 's'}`;

        const count_elem = document.createElement('div');
        count_elem.className = 'bar-count text-xs font-semibold text-slate-300 mt-1';
        count_elem.textContent = count;

        const label = document.createElement('div');
        label.className = 'text-xs text-slate-400 text-center w-full leading-tight';
        label.style.wordWrap = 'break-word';
        label.style.hyphens = 'auto';
        label.textContent = companyName;
        label.title = companyName;

        barWrapper.appendChild(bar);
        barWrapper.appendChild(count_elem);
        barWrapper.appendChild(label);
        chartContainer.appendChild(barWrapper);
      });

      // Add hover effect to dim other bars
      const allBars = chartContainer.querySelectorAll('.bar-wrapper');
      allBars.forEach(wrapper => {
        wrapper.addEventListener('mouseenter', () => {
          allBars.forEach(other => {
            if (other !== wrapper) {
              other.style.opacity = '0.3';
            }
          });
        });
        wrapper.addEventListener('mouseleave', () => {
          allBars.forEach(other => {
            other.style.opacity = '1';
          });
        });
      });
    }

    // Initial render
    renderBars(selectedQuestionId);

    // Handle question selector change
    if (selectEl) {
      selectEl.addEventListener('change', (e) => {
        renderBars(e.target.value);
      });
    }
  </script>

  <script>
    // Company selector navigation
    const companySelector = document.getElementById('company-selector');
    if (companySelector) {
      companySelector.addEventListener('change', (e) => {
        const select = e.target;
        if (select.value) {
          window.location.href = select.value;
        }
      });
    }
  </script>

  <Footer />
</Layout>
