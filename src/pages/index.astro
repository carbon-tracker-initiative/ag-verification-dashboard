---
/**
 * Home page - Verification Dashboard
 * Displays overview of all companies with verified analysis results
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import HeroSection from '../components/home/HeroSection.astro';
import CategoryCard from '../components/home/CategoryCard.astro';
import QuestionRankings from '../components/home/QuestionRankings.astro';

import { loadAllCompanyData } from '../utils/dataLoader';
import { calculateCompanyMetrics, calculateCrossCompanyMetrics, calculateCategoryMetrics } from '../utils/metricsCalculator';

// Get sort parameter from URL
const url = new URL(Astro.request.url);
const sortBy = (url.searchParams.get('sort') as 'quality' | 'question_id' | 'evidence_count') || 'quality';

// Load all company data
const allCompanyData = await loadAllCompanyData();

// Calculate metrics for each company
const companyMetrics = allCompanyData.map(data =>
  calculateCompanyMetrics(data.verified)
);

// Create enriched data with version info
const enrichedCompanyData = allCompanyData.map((data, index) => ({
  data,
  metrics: companyMetrics[index]
}));

// Calculate cross-company metrics
const crossCompanyMetrics = calculateCrossCompanyMetrics(companyMetrics, allCompanyData);

// Get unique categories from all companies
const allCategories = new Set<string>();
allCompanyData.forEach(data => {
  data.verified.analysis_results.forEach(q => allCategories.add(q.category));
});

// Calculate category metrics across all companies
const categoryMetrics = Array.from(allCategories).map(categoryName => {
  // Collect all questions from all companies for this category
  const allQuestionsInCategory = allCompanyData.flatMap(data =>
    data.verified.analysis_results.filter(q => q.category === categoryName)
  );

  return calculateCategoryMetrics(allQuestionsInCategory, categoryName);
});

const normalizedBaseUrl = (import.meta.env.BASE_URL || '').replace(/\/$/, '');
// Build question-to-company disclosure counts (excluding NO_DISCLOSURE)
const questionMap = new Map<string, { question_id: string; question_text: string; companyCounts: Array<{ label: string; href: string; count: number }> }>();

enrichedCompanyData.forEach(({ data }) => {
  const companyLabel = `${data.company} (${data.year}, ${data.version})`;
  const href = `${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`;

  data.verified.analysis_results.forEach(question => {
    const disclosures = Array.isArray(question.disclosures) ? question.disclosures : [];
    const counted = disclosures.filter(d => d.classification !== 'NO_DISCLOSURE').length;

    if (!questionMap.has(question.question_id)) {
      questionMap.set(question.question_id, {
        question_id: question.question_id,
        question_text: question.question_text,
        companyCounts: []
      });
    }
    questionMap.get(question.question_id)!.companyCounts.push({
      label: companyLabel,
      href,
      count: counted
    });
  });
});

const questionOptions = Array.from(questionMap.values()).sort((a, b) => a.question_id.localeCompare(b.question_id));
const selectedQuestionId = url.searchParams.get('question') || '99901';
const chartPayload = questionOptions.map(q => ({
  question_id: q.question_id,
  question_text: q.question_text,
  companyCounts: q.companyCounts.sort((a, b) => b.count - a.count)
}));
---

<Layout title="Verification Dashboard - Home">
  <Header currentPath="/" />

  <main class="min-h-screen">
    <!-- Hero Section with Global Stats -->
    <HeroSection globalStats={crossCompanyMetrics.global_stats} />

    <!-- Company Navigation -->
    <div class="border-b border-slate-800 bg-slate-950/70 py-8">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <label for="company-selector" class="text-lg font-semibold text-slate-100">
            Go directly to a company of your interest
          </label>
          <select
            id="company-selector"
            class="w-full sm:w-96 rounded-md border border-slate-700 bg-slate-900/70 px-4 py-3 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="">Select a company...</option>
            {enrichedCompanyData
              .sort((a, b) => a.data.company.localeCompare(b.data.company))
              .map(({ data }) => (
                <option value={`${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`}>
                  {data.company} - {data.year} ({data.version})
                </option>
              ))}
          </select>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Question-based cross-company disclosure chart -->
      <section class="mb-12">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
          <div>
            <h2 class="text-2xl font-bold text-slate-100">Cross-company disclosures by question</h2>
            <p class="text-sm text-slate-400">Select a risk question to compare total disclosures across companies.</p>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
            <label for="question-selector" class="text-sm font-medium text-slate-300">Choose a question</label>
            <select
              id="question-selector"
              class="w-full sm:w-72 rounded-md border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
            >
              {questionOptions.map(option => (
                <option value={option.question_id} selected={option.question_id === selectedQuestionId}>
                  {option.question_text}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div class="surface border border-slate-800 p-4 sm:p-6 rounded-xl">
          <div class="flex items-center gap-2 text-sm text-slate-500 mb-3">
            <span class="w-3 h-3 rounded-full" style="background-color: #435f74;"></span>
            <span>Count of disclosures</span>
          </div>
          <canvas id="question-chart" aria-label="Disclosure counts by company" role="img"></canvas>
        </div>
      </section>

      <!-- Question Rankings -->
      <QuestionRankings
        questionRankings={crossCompanyMetrics.question_rankings}
        sortBy={sortBy}
      />

      <!-- Category Performance Overview -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Risk Category Performance</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          {categoryMetrics
            .sort((a, b) => b.average_question_score - a.average_question_score)
            .map(category => (
              <CategoryCard category={category} expandable={true} />
            ))}
        </div>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script define:vars={{ chartPayload, selectedQuestionId }}>
    function waitForChart() {
      if (typeof Chart === 'undefined') {
        setTimeout(waitForChart, 50);
        return;
      }

      const canvas = document.getElementById('question-chart');
      const selectEl = document.getElementById('question-selector');
      let chart = null;

      // Set explicit canvas dimensions
      canvas.width = 800;
      canvas.height = 400;
      canvas.style.width = '100%';
      canvas.style.height = '400px';

      function drawChart(questionId) {
        const questionData = chartPayload.find(q => q.question_id === questionId);
        if (!questionData) return;

        // Sort companies alphabetically
        const sorted = [...questionData.companyCounts].sort((a, b) =>
          a.label.localeCompare(b.label)
        );

        const companyLabels = sorted.map(c => c.label);
        const disclosureCounts = sorted.map(c => c.count);
        const companyLinks = sorted.map(c => c.href);

        // Destroy previous chart
        if (chart) {
          chart.destroy();
          chart = null;
        }

        // Create chart with absolutely NO animations
        chart = new Chart(canvas, {
          type: 'bar',
          data: {
            labels: companyLabels,
            datasets: [{
              data: disclosureCounts,
              backgroundColor: '#435f74',
              borderRadius: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
              duration: 0,
              onComplete: function() {},
              onProgress: function() {}
            },
            hover: {
              animationDuration: 0
            },
            responsiveAnimationDuration: 0,
            plugins: {
              legend: false,
              tooltip: {
                enabled: true,
                mode: 'index',
                intersect: true,
                animation: {
                  duration: 0
                },
                callbacks: {
                  label: function(context) {
                    return context.parsed.y + ' disclosure' + (context.parsed.y === 1 ? '' : 's');
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            },
            onClick: function(event, elements) {
              if (elements.length > 0) {
                const index = elements[0].index;
                window.location.href = companyLinks[index];
              }
            }
          }
        });
      }

      // Draw initial chart
      drawChart(selectedQuestionId);

      // Handle question selector change
      selectEl.addEventListener('change', function(e) {
        drawChart(e.target.value);
      });
    }

    waitForChart();
  </script>

  <script>
    // Company selector navigation
    const companySelector = document.getElementById('company-selector');
    if (companySelector) {
      companySelector.addEventListener('change', (e) => {
        const select = e.target;
        if (select.value) {
          window.location.href = select.value;
        }
      });
    }
  </script>

  <Footer />
</Layout>
