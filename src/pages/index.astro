---
/**
 * Home page - Verification Dashboard
 * Displays overview of all companies with verified analysis results
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import HeroSection from '../components/home/HeroSection.astro';
import CategoryCard from '../components/home/CategoryCard.astro';
import QuestionRankings from '../components/home/QuestionRankings.astro';
import CompanyCard from '../components/home/CompanyCard.astro';

import { loadAllCompanyData } from '../utils/dataLoader';
import { calculateCompanyMetrics, calculateCrossCompanyMetrics, calculateCategoryMetrics } from '../utils/metricsCalculator';

// Get sort parameter from URL
const url = new URL(Astro.request.url);
const sortBy = (url.searchParams.get('sort') as 'quality' | 'question_id' | 'evidence_count') || 'quality';

// Load all company data
const allCompanyData = await loadAllCompanyData();

// Calculate metrics for each company
const companyMetrics = allCompanyData.map(data =>
  calculateCompanyMetrics(data.verified)
);

// Create enriched data with version info
const enrichedCompanyData = allCompanyData.map((data, index) => {
  const versionLower = data.version.toLowerCase();
  const isMerged = data.isMerged === true || versionLower.startsWith('merged');
  const sourceVersions = data.mergedMetadata?.sourceVersions ?? [];

  const sourcePresence = isMerged
    ? sourceVersions.map(versionLabel => ({
        version: versionLabel,
        available: allCompanyData.some(entry =>
          entry.company === data.company &&
          entry.year === data.year &&
          entry.version.toLowerCase() === versionLabel.toLowerCase()
        )
      }))
    : [];

  return {
    data,
    metrics: companyMetrics[index],
    isMerged,
    sourcePresence
  };
});

// Calculate cross-company metrics
const crossCompanyMetrics = calculateCrossCompanyMetrics(companyMetrics, allCompanyData);

// Get unique categories from all companies
const allCategories = new Set<string>();
allCompanyData.forEach(data => {
  data.verified.analysis_results.forEach(q => allCategories.add(q.category));
});

// Calculate category metrics across all companies
const categoryMetrics = Array.from(allCategories).map(categoryName => {
  // Collect all questions from all companies for this category
  const allQuestionsInCategory = allCompanyData.flatMap(data =>
    data.verified.analysis_results.filter(q => q.category === categoryName)
  );

  return calculateCategoryMetrics(allQuestionsInCategory, categoryName);
});

const normalizedBaseUrl = (import.meta.env.BASE_URL || '').replace(/\/$/, '');
const companyOptions = enrichedCompanyData
  .slice()
  .sort((a, b) => {
    const nameCompare = a.data.company.localeCompare(b.data.company);
    if (nameCompare !== 0) return nameCompare;
    return b.data.year - a.data.year;
  })
  .map(item => ({
    label: `${item.data.company} â€“ ${item.data.year} (${item.data.version})`,
    href: `${normalizedBaseUrl}/${item.data.company.toLowerCase()}/${item.data.year}/${item.data.version}`
  }));
---

<Layout title="Verification Dashboard - Home">
  <Header currentPath="/" />

  <main class="min-h-screen">
    <!-- Hero Section with Global Stats -->
    <HeroSection globalStats={crossCompanyMetrics.global_stats} />

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Company Cards -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Companies Analyzed</h2>
        <div class="mb-6 flex flex-col gap-2 sm:flex-row sm:items-center">
          <label for="company-selector" class="text-sm font-medium text-slate-700">
            Jump to a company analysis
          </label>
          <select
            id="company-selector"
            class="w-full sm:w-auto rounded-md border border-slate-300 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-1 focus:ring-sky-500"
            onchange="if (this.value) window.location.href = this.value;"
          >
            <option value="">Select a company...</option>
            {companyOptions.map(option => (
              <option value={option.href}>{option.label}</option>
            ))}
          </select>
        </div>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {enrichedCompanyData
            .sort((a, b) => b.metrics.total_snippets - a.metrics.total_snippets)
            .map(item => (
              <CompanyCard
                company={item.metrics}
                version={item.data.version}
                year={item.data.year}
                companyName={item.data.company}
                isMerged={item.isMerged}
                mergedMetadata={item.data.mergedMetadata}
                sourcePresence={item.sourcePresence}
              />
            ))}
        </div>
      </section>

      <!-- Question Rankings -->
      <QuestionRankings
        questionRankings={crossCompanyMetrics.question_rankings}
        sortBy={sortBy}
      />

      <!-- Category Performance Overview -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Risk Category Performance</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          {categoryMetrics
            .sort((a, b) => b.average_question_score - a.average_question_score)
            .map(category => (
              <CategoryCard category={category} expandable={true} />
            ))}
        </div>
      </section>
    </div>
  </main>

  <Footer />
</Layout>
