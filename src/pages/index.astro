---
/**
 * Home page - Verification Dashboard
 * Displays overview of all companies with verified analysis results
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import HeroSection from '../components/home/HeroSection.astro';
import CategoryCard from '../components/home/CategoryCard.astro';
import QuestionRankings from '../components/home/QuestionRankings.astro';

import { loadAllCompanyData } from '../utils/dataLoader';
import { calculateCompanyMetrics, calculateCrossCompanyMetrics, calculateCategoryMetrics } from '../utils/metricsCalculator';

// Get sort parameter from URL
const url = new URL(Astro.request.url);
const sortBy = (url.searchParams.get('sort') as 'quality' | 'question_id' | 'evidence_count') || 'quality';

// Load all company data
const allCompanyData = await loadAllCompanyData();

// Calculate metrics for each company
const companyMetrics = allCompanyData.map(data =>
  calculateCompanyMetrics(data.verified)
);

// Create enriched data with version info
const enrichedCompanyData = allCompanyData.map((data, index) => ({
  data,
  metrics: companyMetrics[index]
}));

// Calculate cross-company metrics
const crossCompanyMetrics = calculateCrossCompanyMetrics(companyMetrics, allCompanyData);

// Get unique categories from all companies
const allCategories = new Set<string>();
allCompanyData.forEach(data => {
  data.verified.analysis_results.forEach(q => allCategories.add(q.category));
});

// Calculate category metrics across all companies
const categoryMetrics = Array.from(allCategories).map(categoryName => {
  // Collect all questions from all companies for this category
  const allQuestionsInCategory = allCompanyData.flatMap(data =>
    data.verified.analysis_results.filter(q => q.category === categoryName)
  );

  return calculateCategoryMetrics(allQuestionsInCategory, categoryName);
});

const normalizedBaseUrl = (import.meta.env.BASE_URL || '').replace(/\/$/, '');
// Build question-to-company disclosure counts (excluding NO_DISCLOSURE)
const questionMap = new Map<string, { question_id: string; question_text: string; companyCounts: Array<{ label: string; href: string; count: number }> }>();

enrichedCompanyData.forEach(({ data }) => {
  const companyLabel = `${data.company} (${data.year}, ${data.version})`;
  const href = `${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`;

  data.verified.analysis_results.forEach(question => {
    const disclosures = Array.isArray(question.disclosures) ? question.disclosures : [];
    const counted = disclosures.filter(d => d.classification !== 'NO_DISCLOSURE').length;

    if (!questionMap.has(question.question_id)) {
      questionMap.set(question.question_id, {
        question_id: question.question_id,
        question_text: question.question_text,
        companyCounts: []
      });
    }
    questionMap.get(question.question_id)!.companyCounts.push({
      label: companyLabel,
      href,
      count: counted
    });
  });
});

const questionOptions = Array.from(questionMap.values()).sort((a, b) => a.question_id.localeCompare(b.question_id));
const selectedQuestionId = url.searchParams.get('question') || '99901';
const chartPayload = questionOptions.map(q => ({
  question_id: q.question_id,
  question_text: q.question_text,
  companyCounts: q.companyCounts.sort((a, b) => b.count - a.count)
}));
---

<Layout title="Verification Dashboard - Home">
  <Header currentPath="/" />

  <main class="min-h-screen">
    <!-- Hero Section with Global Stats -->
    <HeroSection globalStats={crossCompanyMetrics.global_stats} />

    <!-- Company Navigation -->
    <div class="border-b border-slate-800 bg-slate-950/70 py-8">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <label for="company-selector" class="text-lg font-semibold text-slate-100">
            Go directly to a company of your interest
          </label>
          <select
            id="company-selector"
            class="w-full sm:w-96 rounded-md border border-slate-700 bg-slate-900/70 px-4 py-3 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="">Select a company...</option>
            {enrichedCompanyData
              .sort((a, b) => a.data.company.localeCompare(b.data.company))
              .map(({ data }) => (
                <option value={`${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`}>
                  {data.company} - {data.year} ({data.version})
                </option>
              ))}
          </select>
        </div>
      </div>
    </div>

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Question-based cross-company disclosure chart -->
      <section class="mb-12">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
          <div>
            <h2 class="text-2xl font-bold text-slate-100">Cross-company disclosures by question</h2>
            <p class="text-sm text-slate-400">Select a risk question to compare total disclosures (excluding NO_DISCLOSURE) across companies.</p>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
            <label for="question-selector" class="text-sm font-medium text-slate-300">Choose a question</label>
            <select
              id="question-selector"
              class="w-full sm:w-72 rounded-md border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
            >
              {questionOptions.map(option => (
                <option value={option.question_id} selected={option.question_id === selectedQuestionId}>
                  {option.question_text}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div class="surface border border-slate-800 p-4 sm:p-6 rounded-xl">
          <div class="flex items-center gap-2 text-sm text-slate-500 mb-3">
            <span class="w-3 h-3 rounded-full" style="background-color: #435f74;"></span>
            <span>Count of disclosures (excluding NO_DISCLOSURE)</span>
          </div>
          <canvas id="question-chart" aria-label="Disclosure counts by company" role="img"></canvas>
        </div>
      </section>

      <!-- Question Rankings -->
      <QuestionRankings
        questionRankings={crossCompanyMetrics.question_rankings}
        sortBy={sortBy}
      />

      <!-- Category Performance Overview -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Risk Category Performance</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          {categoryMetrics
            .sort((a, b) => b.average_question_score - a.average_question_score)
            .map(category => (
              <CategoryCard category={category} expandable={true} />
            ))}
        </div>
      </section>
    </div>
  </main>

  <script type="module" define:vars={{ chartPayload, selectedQuestionId }}>
    import Chart from 'chart.js/auto';

    const baseColor = '#435f74';

    const selectEl = document.getElementById('question-selector');
    const canvas = document.getElementById('question-chart');
    let chartInstance;

    function renderChart(questionId) {
      const entry = chartPayload.find(q => q.question_id === questionId) || chartPayload[0];
      if (!entry) return;

      const labels = entry.companyCounts.map(c => c.label);
      const data = entry.companyCounts.map(c => c.count);
      const links = entry.companyCounts.map(c => c.href);

      // Adjust height based on number of companies
      if (canvas) {
        const height = Math.max(300, labels.length * 28);
        canvas.style.height = `${height}px`;
      }

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(canvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Disclosures',
              data,
              backgroundColor: baseColor,
              borderRadius: 6
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label(ctx) {
                  const count = ctx.raw ?? 0;
                  return `${count} disclosure${count === 1 ? '' : 's'}`;
                }
              }
            }
          },
          scales: {
            x: { beginAtZero: true, ticks: { precision: 0 } }
          },
          onClick(evt) {
            if (!chartInstance) return;
            const points = chartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, false);
            const idx = points?.[0]?.index;
            if (idx != null) {
              window.location.href = links[idx];
            }
          }
        }
      });
    }

    if (selectEl && chartPayload.length) {
      renderChart(selectedQuestionId);
      selectEl.addEventListener('change', (e) => {
        renderChart(e.target.value);
      });
    }
  </script>

  <script>
    // Company selector navigation
    const companySelector = document.getElementById('company-selector');
    if (companySelector) {
      companySelector.addEventListener('change', (e) => {
        const select = e.target;
        if (select.value) {
          window.location.href = select.value;
        }
      });
    }
  </script>

  <Footer />
</Layout>
