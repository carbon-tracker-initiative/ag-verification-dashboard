---
/**
 * Home page - Verification Dashboard
 * Displays overview of all companies with verified analysis results
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import ReportIntroSection from '../components/home/ReportIntroSection.astro';
import HeroSection from '../components/home/HeroSection.astro';
import CategoryCard from '../components/home/CategoryCard.astro';
import QuestionRankings from '../components/home/QuestionRankings.astro';

import { loadAllCompanyData } from '../utils/dataLoader';
import { calculateCompanyMetrics, calculateCrossCompanyMetrics, calculateCategoryMetrics } from '../utils/metricsCalculator';

// Get sort parameter from URL
const url = new URL(Astro.request.url);
const sortBy = (url.searchParams.get('sort') as 'quality' | 'question_id' | 'evidence_count') || 'quality';

// Load all company data
const allCompanyData = await loadAllCompanyData();

// Calculate metrics for each company
const companyMetrics = allCompanyData.map(data =>
  calculateCompanyMetrics(data.verified)
);

// Create enriched data with version info
const enrichedCompanyData = allCompanyData.map((data, index) => ({
  data,
  metrics: companyMetrics[index]
}));

// Calculate cross-company metrics
const crossCompanyMetrics = calculateCrossCompanyMetrics(companyMetrics, allCompanyData);

// Get unique categories from all companies
const allCategories = new Set<string>();
allCompanyData.forEach(data => {
  data.verified.analysis_results.forEach(q => allCategories.add(q.category));
});

// Calculate category metrics across all companies
const categoryMetrics = Array.from(allCategories).map(categoryName => {
  // Collect all questions from all companies for this category
  const allQuestionsInCategory = allCompanyData.flatMap(data =>
    data.verified.analysis_results.filter(q => q.category === categoryName)
  );

  return calculateCategoryMetrics(allQuestionsInCategory, categoryName);
});

const normalizedBaseUrl = (import.meta.env.BASE_URL || '').replace(/\/$/, '');
// Build question-to-company disclosure counts (excluding NO_DISCLOSURE)
const questionMap = new Map<string, { question_id: string; question_text: string; companyCounts: Array<{ label: string; href: string; count: number }> }>();

enrichedCompanyData.forEach(({ data }) => {
  const companyLabel = `${data.company} (${data.year}, ${data.version})`;
  const href = `${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`;

  data.verified.analysis_results.forEach(question => {
    const disclosures = Array.isArray(question.disclosures) ? question.disclosures : [];
    const counted = disclosures.filter(d => d.classification !== 'NO_DISCLOSURE').length;

    if (!questionMap.has(question.question_id)) {
      questionMap.set(question.question_id, {
        question_id: question.question_id,
        question_text: question.question_text,
        companyCounts: []
      });
    }
    questionMap.get(question.question_id)!.companyCounts.push({
      label: companyLabel,
      href,
      count: counted
    });
  });
});

const questionOptions = Array.from(questionMap.values()).sort((a, b) => a.question_id.localeCompare(b.question_id));
const selectedQuestionId = url.searchParams.get('question') || '99903';

// Function to strip common prefix from question text for dropdown display
function stripQuestionPrefix(text: string): string {
  return text
    .replace(/^Does the company disclose whether it thinks that /i, '')
    .replace(/^Does the company disclose whether it thinks /i, '')
    .replace(/^Does the company disclose that /i, '')
    .replace(/^Does the company disclose /i, '');
}

// Create sector label mapping
const sectorLabelMap: Record<string, string> = {
  F: 'F',
  P: 'P',
  PF: 'F&P',
  ALL: 'F&P'
};

// Build company to sector mapping from loaded data
const companyToSector = new Map<string, string>();
enrichedCompanyData.forEach(({ data }) => {
  const companyName = data.company;
  const sector = data.sector || 'ALL'; // This is already the applied sector code
  const sectorLabel = sectorLabelMap[sector] || 'F&P';
  companyToSector.set(companyName, sectorLabel);
});

// Question sector applicability mapping
const questionApplicability: Record<string, { sector: string; label: string }> = {
  '99901': { sector: 'P', label: 'Applicable only to Crop protection sector' },
  '99902': { sector: 'F', label: 'Applicable only to Fertilizers sector' },
  '99903': { sector: 'PF', label: 'Applicable to both sectors' },
  '99904': { sector: 'PF', label: 'Applicable to both sectors' },
  '99905': { sector: 'P', label: 'Applicable only to Crop protection sector' },
  '99906': { sector: 'P', label: 'Applicable only to Crop protection sector' },
  '99907': { sector: 'PF', label: 'Applicable to both sectors' },
  '99908': { sector: 'PF', label: 'Applicable to both sectors' },
  '99909': { sector: 'PF', label: 'Applicable to both sectors' },
  '99910': { sector: 'F', label: 'Applicable only to Fertilizers sector' },
  '99911': { sector: 'F', label: 'Applicable only to Fertilizers sector' },
  '99912': { sector: 'PF', label: 'Applicable to both sectors' },
  '99913': { sector: 'PF', label: 'Applicable to both sectors' },
  '99914': { sector: 'P', label: 'Applicable only to Crop protection sector' },
  '99915': { sector: 'PF', label: 'Applicable to both sectors' },
  '99916': { sector: 'PF', label: 'Applicable to both sectors' },
  '99917': { sector: 'PF', label: 'Applicable to both sectors' },
  '99918': { sector: 'F', label: 'Applicable only to Fertilizers sector' }
};

const chartPayload = questionOptions.map(q => ({
  question_id: q.question_id,
  question_text: q.question_text,
  companyCounts: q.companyCounts.sort((a, b) => b.count - a.count)
}));

const sectorMapping = Object.fromEntries(companyToSector);
const applicabilityMapping = questionApplicability;
---

<Layout title="Cultivating Transparency Dashboard">
  <Header currentPath="/" />

  <main class="min-h-screen">
    <!-- Report Introduction Section -->
    <ReportIntroSection />

    <!-- Hero Section with Global Stats -->
    <HeroSection globalStats={crossCompanyMetrics.global_stats} />

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Question-based cross-company disclosure chart -->
      <section class="mb-12">
        <div class="mb-4">
          <h2 class="text-2xl font-bold text-slate-100 mb-2">Cross-company disclosures by question</h2>
          <p class="text-sm text-slate-400 mb-3">Select a risk question to compare total disclosures across companies.</p>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:flex-wrap">
            <label for="question-selector" class="text-sm font-medium text-slate-100 whitespace-nowrap">
              <span class="text-slate-100">Does the company disclose whether it thinks</span>
            </label>
            <select
              id="question-selector"
              class="flex-1 min-w-0 rounded-md border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
            >
              {questionOptions.map(option => (
                <option value={option.question_id} selected={option.question_id === selectedQuestionId}>
                  {stripQuestionPrefix(option.question_text)}
                </option>
              ))}
            </select>
          </div>
        </div>

        <div class="mb-3 h-16 flex items-start">
          <h3 id="question-title" class="text-lg font-semibold text-sky-400 line-clamp-3">Does the company disclose...</h3>
        </div>
        <div class="mb-3 -mt-2">
          <p id="question-applicability" class="text-[13px] text-slate-400 italic"></p>
        </div>

        <!-- Sector Legend and Instructions -->
        <div class="mb-4 text-xs text-slate-400 pb-3">
          <div class="font-semibold text-slate-300 mb-1">Company's sector:</div>
          <div class="flex gap-4 mb-2">
            <span><strong class="text-slate-200">F</strong> = Fertilizers</span>
            <span><strong class="text-slate-200">P</strong> = Crop protection</span>
            <span><strong class="text-slate-200">F&P</strong> = Both</span>
          </div>
          <div class="text-[13px] text-slate-500 italic">
            üí° Click on any bar to explore the company's detailed disclosures
          </div>
        </div>

        <!-- Question Navigation Controls -->
        <div class="mb-4">
          <div class="flex items-center justify-center gap-4">
            <button
              id="prev-question"
              class="flex items-center gap-2 px-4 py-2 rounded-md border border-slate-700 bg-slate-900/70 text-slate-200 hover:bg-slate-800 hover:border-slate-600 transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
              title="Previous question (or use ‚Üë arrow key)"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
              <span class="text-sm font-medium">Previous</span>
            </button>

            <div class="text-xs text-slate-500 text-center">
              Navigate with keyboard: <kbd class="px-1.5 py-0.5 bg-slate-800 rounded border border-slate-700">‚Üë</kbd> <kbd class="px-1.5 py-0.5 bg-slate-800 rounded border border-slate-700">‚Üì</kbd> <kbd class="px-1.5 py-0.5 bg-slate-800 rounded border border-slate-700">‚Üê</kbd> <kbd class="px-1.5 py-0.5 bg-slate-800 rounded border border-slate-700">‚Üí</kbd>
            </div>

            <button
              id="next-question"
              class="flex items-center gap-2 px-4 py-2 rounded-md border border-slate-700 bg-slate-900/70 text-slate-200 hover:bg-slate-800 hover:border-slate-600 transition-colors disabled:opacity-40 disabled:cursor-not-allowed"
              title="Next question (or use ‚Üì arrow key)"
            >
              <span class="text-sm font-medium">Next</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
        </div>

        <div class="surface border border-slate-800 p-4 sm:p-6 rounded-xl">
          <div class="flex items-center gap-2 text-sm text-slate-500 mb-3">
            <span class="w-3 h-3 rounded-full" style="background-color: #10b981;"></span>
            <span class="text-emerald-400 font-medium">Total disclosures</span>
          </div>
          <div id="question-chart" class="flex flex-col gap-1 w-full px-4 py-2" style="max-width: 80%;">
            <!-- Bars will be rendered here via JavaScript -->
          </div>
        </div>
      </section>

      <!-- Company Navigation -->
      <section class="mb-12 border-t border-slate-800 pt-8">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:gap-4">
          <label for="company-selector" class="text-lg font-semibold text-slate-100">
            Go directly to the 2024 disclosures of a company of your interest
          </label>
          <select
            id="company-selector"
            class="w-full sm:w-80 rounded-md border border-slate-700 bg-slate-900/70 px-4 py-3 text-sm text-slate-100 shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500"
          >
            <option value="">Select a company...</option>
            {enrichedCompanyData
              .sort((a, b) => a.data.company.localeCompare(b.data.company))
              .map(({ data }) => (
                <option value={`${normalizedBaseUrl}/${data.company.toLowerCase()}/${data.year}/${data.version}`}>
                  {data.company}
                </option>
              ))}
          </select>
        </div>
      </section>
    </div>
  </main>

  <script define:vars={{ chartPayload, selectedQuestionId, sectorMapping, applicabilityMapping }}>
    const chartContainer = document.getElementById('question-chart');
    const selectEl = document.getElementById('question-selector');
    const questionTitle = document.getElementById('question-title');
    const questionApplicability = document.getElementById('question-applicability');

    function updateQuestionTitle(questionId) {
      const questionData = chartPayload.find(q => q.question_id === questionId);
      if (!questionData || !questionTitle) return;

      // Show full question text in title
      questionTitle.textContent = questionData.question_text;
      
      // Update applicability info
      if (questionApplicability && applicabilityMapping[questionId]) {
        questionApplicability.textContent = applicabilityMapping[questionId].label;
      } else if (questionApplicability) {
        questionApplicability.textContent = '';
      }
    }

    function getShortQuestionText(fullText) {
      // Remove "Does the company disclose whether it thinks" from the beginning
      return fullText
        .replace(/^Does the company disclose whether it thinks that /i, '')
        .replace(/^Does the company disclose whether it thinks /i, '')
        .replace(/^Does the company disclose that /i, '')
        .replace(/^Does the company disclose /i, '');
    }

    function renderBars(questionId) {
      const questionData = chartPayload.find(q => q.question_id === questionId);
      if (!questionData || !chartContainer) return;

      // Update question title
      updateQuestionTitle(questionId);

      // Create a map for quick lookup of counts by company label
      const countMap = new Map(questionData.companyCounts.map(c => [c.label, c]));

      // Get all unique companies from all questions and sort by count (descending)
      const allCompanies = new Set();
      chartPayload.forEach(q => {
        q.companyCounts.forEach(c => allCompanies.add(c.label));
      });
      const sortedCompanies = Array.from(allCompanies).sort((a, b) => {
        const countA = countMap.get(a)?.count || 0;
        const countB = countMap.get(b)?.count || 0;
        // Primary sort: by count (descending)
        if (countB !== countA) {
          return countB - countA;
        }
        // Secondary sort: alphabetically (ascending) for ties
        return a.localeCompare(b);
      });

      // Find max value for scaling across all companies
      const allCounts = sortedCompanies.map(label => countMap.get(label)?.count || 0);
      const maxCount = Math.max(...allCounts, 1);

      // Always clear and create new bars to ensure correct order and click handlers
      chartContainer.innerHTML = '';

      // Create horizontal bars for ALL companies
      sortedCompanies.forEach((companyLabel, index) => {
        const companyData = countMap.get(companyLabel);
        const count = companyData?.count || 0;

        // Get the question text for this question ID
        const currentQuestionData = chartPayload.find(q => q.question_id === questionId);
        const questionText = currentQuestionData ? encodeURIComponent(currentQuestionData.question_text) : '';
        const href = companyData ? `${companyData.href}#question-${questionId}&qtext=${questionText}` : '#';

        // Calculate width percentage with minimum of 2% for bars with counts
        const widthPercent = Math.max(2, (count / maxCount) * 100);

        // Extract just company name (remove year and team-reviewed)
        const companyName = companyLabel.split('(')[0].trim();

        const barWrapper = document.createElement('div');

        // Only make clickable if count > 0, otherwise just show as non-interactive
        if (count > 0 && companyData) {
          barWrapper.className = 'bar-wrapper flex flex-row items-center gap-3 w-full cursor-pointer hover:bg-slate-900/30 rounded-lg p-1.5 transition-all duration-200';
          barWrapper.onclick = () => window.location.href = href;
        } else {
          barWrapper.className = 'bar-wrapper flex flex-row items-center gap-3 w-full rounded-lg p-1.5';
        }

        // Company name label at LEFT
        const label = document.createElement('div');
        label.className = 'text-sm text-slate-300 font-medium text-left flex-shrink-0';
        label.style.width = '140px';
        label.style.overflow = 'hidden';
        label.style.textOverflow = 'ellipsis';
        label.style.whiteSpace = 'nowrap';
        label.textContent = companyName;
        label.title = companyName;

        // Bar container (flex-1 to fill available space, flex-row for bar + count)
        const barContainer = document.createElement('div');
        barContainer.className = 'flex-1 flex flex-row items-center gap-2';
        barContainer.style.minWidth = '0';

        // Bar element
        const bar = document.createElement('div');
        bar.className = 'chart-bar h-8 rounded shadow-lg relative flex items-center';
        bar.style.width = count === 0 ? '60px' : `${widthPercent}%`;
        bar.style.background = count === 0
          ? 'linear-gradient(90deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%)'
          : 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
        bar.style.opacity = count === 0 ? '0.15' : '1';
        bar.style.border = count === 0 ? '1px dashed rgba(100, 116, 139, 0.3)' : 'none';
        bar.style.boxShadow = count === 0
          ? 'none'
          : '0 2px 4px -1px rgba(16, 185, 129, 0.3), 0 1px 2px -1px rgba(16, 185, 129, 0.2)';
        bar.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
        bar.title = `${companyName}: ${count} disclosure${count === 1 ? '' : 's'}`;

        // Sector label INSIDE the bar (absolute positioned)
        const sectorLabel = document.createElement('div');
        sectorLabel.className = 'text-xs font-semibold absolute right-2';
        sectorLabel.style.color = count === 0
          ? 'rgba(148, 163, 184, 0.9)'  // More visible gray for zero-count
          : 'rgba(255, 255, 255, 0.7)';  // Semi-transparent white
        sectorLabel.style.textShadow = count === 0
          ? 'none'
          : '0 1px 2px rgba(0, 0, 0, 0.3)'; // Subtle shadow for readability
        sectorLabel.style.pointerEvents = 'none';
        sectorLabel.textContent = sectorMapping[companyName] || 'F&P';

        // Count element NEXT TO bar
        const count_elem = document.createElement('div');
        count_elem.className = 'bar-count text-sm font-semibold text-slate-300 flex-shrink-0';
        count_elem.style.minWidth = '30px';
        count_elem.style.textAlign = 'left';
        count_elem.textContent = count;

        // Assemble DOM: label ‚Üí barContainer (bar + count)
        bar.appendChild(sectorLabel);
        barContainer.appendChild(bar);
        barContainer.appendChild(count_elem);
        barWrapper.appendChild(label);
        barWrapper.appendChild(barContainer);
        chartContainer.appendChild(barWrapper);
      });

      // Add hover effect to dim other bars
      const allBars = chartContainer.querySelectorAll('.bar-wrapper');
      allBars.forEach(wrapper => {
        wrapper.addEventListener('mouseenter', () => {
          allBars.forEach(other => {
            if (other !== wrapper) {
              other.style.opacity = '0.5';
            }
          });
        });
        wrapper.addEventListener('mouseleave', () => {
          allBars.forEach(other => {
            other.style.opacity = '1';
          });
        });
      });
    }

    // Initial render
    renderBars(selectedQuestionId);

    // Handle question selector change
    if (selectEl) {
      selectEl.addEventListener('change', (e) => {
        renderBars(e.target.value);
      });
    }
  </script>

  <script>
    // Company selector navigation
    const companySelector = document.getElementById('company-selector');
    if (companySelector) {
      companySelector.addEventListener('change', (e) => {
        const select = e.target;
        if (select.value) {
          window.location.href = select.value;
        }
      });
    }

    // Question navigation controls
    const prevBtn = document.getElementById('prev-question');
    const nextBtn = document.getElementById('next-question');
    const questionSelect = document.getElementById('question-selector');

    function updateNavigationButtons() {
      if (!questionSelect) return;
      const currentIndex = questionSelect.selectedIndex;
      const totalOptions = questionSelect.options.length;
      
      if (prevBtn) {
        prevBtn.disabled = currentIndex === 0;
      }
      if (nextBtn) {
        nextBtn.disabled = currentIndex === totalOptions - 1;
      }
    }

    function navigateQuestion(direction) {
      if (!questionSelect) return;
      const currentIndex = questionSelect.selectedIndex;
      const newIndex = direction === 'prev' ? currentIndex - 1 : currentIndex + 1;
      
      if (newIndex >= 0 && newIndex < questionSelect.options.length) {
        questionSelect.selectedIndex = newIndex;
        questionSelect.dispatchEvent(new Event('change'));
        updateNavigationButtons();
      }
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', () => navigateQuestion('prev'));
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => navigateQuestion('next'));
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
        e.preventDefault();
        navigateQuestion('prev');
      } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
        e.preventDefault();
        navigateQuestion('next');
      }
    });

    // Initialize button states
    updateNavigationButtons();
    if (questionSelect) {
      questionSelect.addEventListener('change', updateNavigationButtons);
    }
  </script>

  <Footer />
</Layout>
