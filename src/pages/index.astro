---
/**
 * Home page - Verification Dashboard
 * Displays overview of all companies with verified analysis results
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import HeroSection from '../components/home/HeroSection.astro';
import CategoryCard from '../components/home/CategoryCard.astro';
import QuestionRankings from '../components/home/QuestionRankings.astro';
import CompanyCard from '../components/home/CompanyCard.astro';

import { loadAllCompanyData } from '../utils/dataLoader';
import { calculateCompanyMetrics, calculateCrossCompanyMetrics, calculateCategoryMetrics } from '../utils/metricsCalculator';

// Get sort parameter from URL
const url = new URL(Astro.request.url);
const sortBy = (url.searchParams.get('sort') as 'quality' | 'question_id' | 'evidence_count') || 'quality';

// Load all company data
const allCompanyData = await loadAllCompanyData();

// Calculate metrics for each company
const companyMetrics = allCompanyData.map(data =>
  calculateCompanyMetrics(data.verified)
);

// Calculate cross-company metrics
const crossCompanyMetrics = calculateCrossCompanyMetrics(companyMetrics);

// Get unique categories from all companies
const allCategories = new Set<string>();
companyMetrics.forEach(cm => {
  Object.keys(cm.category_scores).forEach(cat => allCategories.add(cat));
});

// Calculate category metrics across all companies
const categoryMetrics = Array.from(allCategories).map(categoryName => {
  // Collect all questions from all companies for this category
  const allQuestionsInCategory = allCompanyData.flatMap(data =>
    data.verified.analysis_results.filter(q => q.category === categoryName)
  );

  return calculateCategoryMetrics(allQuestionsInCategory, categoryName);
});
---

<Layout title="Verification Dashboard - Home">
  <Header currentPath="/" />

  <main class="min-h-screen">
    <!-- Hero Section with Global Stats -->
    <HeroSection globalStats={crossCompanyMetrics.global_stats} />

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Company Cards -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Companies Analyzed</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {companyMetrics
            .sort((a, b) => b.overall_disclosure_score - a.overall_disclosure_score)
            .map(company => (
              <CompanyCard company={company} />
            ))}
        </div>
      </section>

      <!-- Question Rankings -->
      <QuestionRankings
        questionRankings={crossCompanyMetrics.question_rankings}
        sortBy={sortBy}
      />

      <!-- Category Performance Overview -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-900 mb-6">Risk Category Performance</h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          {categoryMetrics
            .sort((a, b) => b.average_question_score - a.average_question_score)
            .map(category => (
              <CategoryCard category={category} expandable={true} />
            ))}
        </div>
      </section>
    </div>
  </main>

  <Footer />
</Layout>
