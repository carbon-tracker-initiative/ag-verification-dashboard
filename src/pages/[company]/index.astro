---
import Layout from '../../layouts/Layout.astro';
import {
  loadCompanyResults,
  getCompanyYears,
  getAvailableCompanies,
  calculateApplicableQuestions,
  loadQuestionsMetadata,
  extractDragCanonicalQuestions,
  findCommonCanonicalQuestions,
  filterQuestionsByIds,
  getDefaultModel
} from '../../utils/dataLoader';
import { calculateCategoryStats, groupQuestionsByCategory, getCategoryGroup } from '../../utils/categoryMapper';
import TimelineChart from '../../components/TimelineChart.astro';
import MatrixView from '../../components/MatrixView.astro';
import ClassificationBar from '../../components/ClassificationBar.astro';
import MultiYearBarChart from '../../components/MultiYearBarChart.astro';

// Get company from URL
const { company } = Astro.params;

if (!company) {
  return Astro.redirect('/');
}

// Get model from URL query parameters
const url = new URL(Astro.request.url);
let model = url.searchParams.get('model') || undefined;

// If no model specified, use default (flash preferred over pro)
if (!model) {
  model = await getDefaultModel(company) || undefined;
}

// Load company data (filtered by model if specified)
const results = await loadCompanyResults(company, model);

const years = await getCompanyYears(company);

if (results.length === 0) {
  return Astro.redirect('/');
}

// Separate our system vs D-RAG results
const ourResults = results.filter(r => r.metadata.model_used !== 'D-RAG');
const dragResults = results.filter(r => r.metadata.model_used === 'D-RAG');

// Calculate overall statistics (deduplicate questions by ID)
const allQuestionsRaw = results.flatMap(r => r.questions);
const questionMap = new Map();
allQuestionsRaw.forEach(q => {
  if (q && q.question_id) {
    // Keep first occurrence of each question ID (prefer N-LLM over D-RAG if same ID)
    if (!questionMap.has(q.question_id)) {
      questionMap.set(q.question_id, q);
    }
  }
});
const allQuestions = Array.from(questionMap.values());
const groupedByCategory = groupQuestionsByCategory(allQuestions);
const overallStats = calculateCategoryStats(allQuestions);

// Calculate applicable questions for this company
const applicableInfo = await calculateApplicableQuestions(company, allQuestions);

// Load questions metadata for total canonical count
const questionsMetadata = await loadQuestionsMetadata();
const totalCanonicalQuestions = questionsMetadata._meta.total_canonical_questions;

// Calculate separate stats for N-LLM and D-RAG
const nllmQuestions = ourResults.flatMap(r => r.questions);
const dragQuestions = dragResults.flatMap(r => r.questions);
const nllmStats = calculateCategoryStats(nllmQuestions);
const dragStats = dragResults.length > 0 ? calculateCategoryStats(dragQuestions) : null;

// Extract DRAG canonical questions (DRAG only uses canonical, no variants)
const dragCanonicalQuestions = dragQuestions.length > 0
  ? await extractDragCanonicalQuestions(dragQuestions)
  : [];

// Find common canonical questions for direct comparison between systems
// Pass company sector to filter out questions not applicable to this company
const canonicalComparison = dragQuestions.length > 0
  ? await findCommonCanonicalQuestions(nllmQuestions, dragQuestions, applicableInfo.companySector)
  : {
      commonCanonicals: [],
      nllmOnlyCanonicals: [],
      dragOnlyCanonicals: [],
      commonCount: 0,
      nllmOnlyCount: 0,
      dragOnlyCount: 0
    };

// Create a set of common canonical IDs for filtering
const commonCanonicalIds = new Set(canonicalComparison.commonCanonicals.map(q => q.id));

// Year-by-year breakdown
const yearlyData = years.map(year => {
  const ourResult = ourResults.find(r => r.metadata.fiscal_year === year);
  const dragResult = dragResults.find(r => r.metadata.fiscal_year === year);

  const nllmYearQuestions = ourResult?.questions || [];
  const dragYearQuestions = dragResult?.questions || [];

  // Calculate stats for all questions
  const nllmYearStats = ourResult ? calculateCategoryStats(nllmYearQuestions) : null;
  const dragYearStats = dragResult ? calculateCategoryStats(dragYearQuestions) : null;

  // Calculate stats for canonical-only questions (common canonicals)
  const nllmCanonicalOnlyQuestions = filterQuestionsByIds(nllmYearQuestions, commonCanonicalIds);
  const dragCanonicalOnlyQuestions = filterQuestionsByIds(dragYearQuestions, commonCanonicalIds);

  const nllmCanonicalStats = nllmCanonicalOnlyQuestions.length > 0
    ? calculateCategoryStats(nllmCanonicalOnlyQuestions)
    : null;
  const dragCanonicalStats = dragCanonicalOnlyQuestions.length > 0
    ? calculateCategoryStats(dragCanonicalOnlyQuestions)
    : null;

  return {
    year,
    nllmStats: nllmYearStats,
    dragStats: dragYearStats,
    nllmCanonicalStats,  // Stats for common canonicals only
    dragCanonicalStats,  // Stats for common canonicals only
    hasNllm: !!ourResult,
    hasDrag: !!dragResult,
    nllmModel: ourResult?.metadata.model_used || 'N/A',
    dragModel: dragResult?.metadata.model_used || 'D-RAG',
  };
});

// Prepare data for Matrix View and Timeline (Our System)
const ourQuestionsByYear = new Map();
ourResults.forEach(result => {
  // Safety check for questions array
  if (!result.questions || !Array.isArray(result.questions)) {
    return;
  }

  const year = result.metadata.fiscal_year;
  const questionMap = new Map();
  result.questions.forEach(q => {
    questionMap.set(q.question_id, q);
  });
  ourQuestionsByYear.set(year, questionMap);
});

// Prepare multi-year donut chart data (all questions - canonical + variants)
const nllmMultiYearData = yearlyData
  .filter(yd => yd.hasNllm && yd.nllmStats)
  .map(yd => ({
    year: yd.year,
    data: yd.nllmStats!.byClassification,
    total: yd.nllmStats!.total
  }));

const dragMultiYearData = yearlyData
  .filter(yd => yd.hasDrag && yd.dragStats)
  .map(yd => ({
    year: yd.year,
    data: yd.dragStats!.byClassification,
    total: yd.dragStats!.total
  }));

// Prepare canonical-only multi-year data (common canonicals)
const nllmCanonicalMultiYearData = yearlyData
  .filter(yd => yd.hasNllm && yd.nllmCanonicalStats)
  .map(yd => ({
    year: yd.year,
    data: yd.nllmCanonicalStats!.byClassification,
    total: yd.nllmCanonicalStats!.total
  }));

const dragCanonicalMultiYearData = yearlyData
  .filter(yd => yd.hasDrag && yd.dragCanonicalStats)
  .map(yd => ({
    year: yd.year,
    data: yd.dragCanonicalStats!.byClassification,
    total: yd.dragCanonicalStats!.total
  }));

// Prepare data for D-RAG
const dragQuestionsByYear = new Map();
dragResults.forEach(result => {
  // Safety check for questions array
  if (!result.questions || !Array.isArray(result.questions)) {
    return;
  }

  const year = result.metadata.fiscal_year;
  const questionMap = new Map();
  result.questions.forEach(q => {
    questionMap.set(q.question_id, q);
  });
  dragQuestionsByYear.set(year, questionMap);
});

// For Matrix View, combine both (prefer our system)
const questionsByYear = new Map(ourQuestionsByYear);
---

<Layout title={`${company} - Analysis Overview`}>
  <div class="min-h-screen bg-slate-900">
    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700">
      <div class="container mx-auto px-6 py-6">
        <a href="/" class="text-emerald-400 hover:text-emerald-300 text-sm mb-2 inline-block">
          ‚Üê Back to Home
        </a>
        <div class="flex items-start justify-between">
          <div>
            <h1 class="text-4xl font-bold text-slate-100 mb-2">
              {company}
            </h1>
            <p class="text-slate-300">
              Risk Disclosure Analysis - {years[0]} to {years[years.length - 1]}
            </p>
            {model && (
              <p class="text-sm text-blue-400 mt-2 font-mono">
                Using: {model}
              </p>
            )}
          </div>
          <div class="text-right">
            <div class="text-sm text-slate-400">Company Sector</div>
            <div class="text-2xl font-bold text-purple-400">
              {applicableInfo.companySector}
            </div>
            <div class="text-xs text-slate-400 mt-1">
              {applicableInfo.companySector === 'P' ? 'Pesticides' :
               applicableInfo.companySector === 'F' ? 'Fertilizers' : 'Both'}
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12">
      <!-- Summary Stats -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-100 mb-6">üìä Summary</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
          <div class="card">
            <div class="text-3xl font-bold text-emerald-400 mb-2">{years.length}</div>
            <div class="text-slate-300">Years Analyzed</div>
          </div>

          <div class="card">
            <div class="text-3xl font-bold text-emerald-400 mb-2">{ourResults.length}</div>
            <div class="text-slate-300">N-LLM Analyses</div>
          </div>

          <div class="card">
            <div class="text-3xl font-bold text-amber-400 mb-2">{dragResults.length}</div>
            <div class="text-slate-300">D-RAG Baseline Analyses</div>
          </div>

          <div class="card">
            <div class="text-3xl font-bold text-purple-400 mb-2">
              {applicableInfo.totalApplicable}
            </div>
            <div class="text-slate-300 text-sm">Applicable Questions</div>
            <div class="text-xs text-slate-400 mt-2">
              {applicableInfo.totalCanonical}/{totalCanonicalQuestions} canonical + {applicableInfo.totalVariants} variants
            </div>
          </div>

          <div class="card">
            <div class="text-3xl font-bold text-blue-400 mb-2">
              {overallStats.total}
            </div>
            <div class="text-slate-300 text-sm">Questions Analyzed</div>
            <div class="text-xs text-slate-400 mt-2">
              Across all years
            </div>
          </div>
        </div>
      </section>

      <!-- Question Applicability Details -->
      <section class="mb-12">
        <div class="card">
          <h2 class="text-2xl font-bold text-slate-100 mb-6">üìã Question Applicability Details</h2>

          <div class="mb-6 p-4 bg-slate-800/50 rounded-lg">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-sm text-slate-400 mb-1">Company Sector</div>
                <div class="text-lg font-bold text-purple-400">
                  {applicableInfo.companySector === 'P' ? 'Pesticides (P)' :
                   applicableInfo.companySector === 'F' ? 'Fertilizers (F)' : 'Both (PF)'}
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm text-slate-400 mb-1">Common Canonical Questions</div>
                <div class="text-3xl font-bold text-cyan-400">
                  {canonicalComparison.commonCount}/{totalCanonicalQuestions}
                </div>
                <div class="text-xs text-slate-400 mt-1">
                  Used by both systems for comparison
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- N-LLM Questions (Left Column) -->
            <div class="border-r border-slate-700 pr-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-emerald-400 flex items-center gap-2">
                  <span>ü§ñ</span> N-LLM Questions
                </h3>
                <div class="text-right">
                  <div class="text-2xl font-bold text-emerald-400">
                    {applicableInfo.totalApplicable}
                  </div>
                  <div class="text-xs text-slate-400">
                    {applicableInfo.totalCanonical} + {applicableInfo.totalVariants} variants
                  </div>
                </div>
              </div>
              <p class="text-sm text-slate-400 mb-6">
                Canonical questions + company-specific variants
              </p>

              <!-- Applicable Canonical Questions -->
              <div class="mb-6">
                <details class="group">
                  <summary class="cursor-pointer list-none">
                    <h4 class="text-md font-semibold text-emerald-300 mb-3 flex items-center gap-2 inline-flex">
                      <span class="group-open:rotate-90 transition-transform">‚ñ∂</span>
                      <span>‚úì</span> Canonical ({applicableInfo.totalCanonical}/{totalCanonicalQuestions})
                      <span class="text-xs text-slate-400 font-normal ml-2">Click to expand</span>
                    </h4>
                  </summary>
                  <div class="mt-3 space-y-2 max-h-96 overflow-y-auto">
                    {applicableInfo.applicableCanonical.map((q) => (
                      <div class="p-3 bg-slate-800/50 rounded border border-slate-700 hover:border-emerald-500/50 transition-colors">
                        <div class="flex items-start justify-between gap-2 mb-1">
                          <span class="font-mono text-xs text-emerald-400">{q.id}</span>
                          <span class="text-xs px-2 py-0.5 rounded bg-purple-500/20 text-purple-400">
                            {q.sector}
                          </span>
                        </div>
                        <div class="text-sm text-slate-300">{q.text}</div>
                        <div class="text-xs text-slate-500 mt-1">{q.category}</div>
                      </div>
                    ))}
                  </div>
                </details>
              </div>

              <!-- Company-Specific Variants -->
              <div>
                <details class="group">
                  <summary class="cursor-pointer list-none">
                    <h4 class="text-md font-semibold text-amber-400 mb-3 flex items-center gap-2 inline-flex">
                      <span class="group-open:rotate-90 transition-transform">‚ñ∂</span>
                      <span>‚ö°</span> Company Variants ({applicableInfo.totalVariants})
                      <span class="text-xs text-slate-400 font-normal ml-2">Click to expand</span>
                    </h4>
                  </summary>
                  {applicableInfo.totalVariants > 0 ? (
                    <div class="mt-3 space-y-2 max-h-96 overflow-y-auto">
                      {applicableInfo.companyVariants.map((q) => (
                        <div class="p-3 bg-slate-800/50 rounded border border-slate-700 hover:border-amber-500/50 transition-colors">
                          <div class="flex items-start justify-between gap-2 mb-1">
                            <span class="font-mono text-xs text-amber-400">{q.id}</span>
                            <span class="text-xs px-2 py-0.5 rounded bg-blue-500/20 text-blue-400">
                              Based on {q.canonical_id}
                            </span>
                          </div>
                          <div class="text-sm text-slate-300">{q.text}</div>
                          <div class="text-xs text-slate-500 mt-1">{q.category}</div>
                          {q.adaptation_reason && (
                            <div class="text-xs text-slate-400 mt-2 italic">
                              {q.adaptation_reason}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div class="mt-3 p-6 bg-slate-800/30 rounded border border-slate-700 text-center">
                      <p class="text-slate-400 text-sm">No variants for {company}</p>
                    </div>
                  )}
                </details>
              </div>
            </div>

            <!-- D-RAG Questions (Right Column) -->
            <div class="pl-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-cyan-400 flex items-center gap-2">
                  <span>üìä</span> D-RAG Questions
                </h3>
                <div class="text-right">
                  <div class="text-2xl font-bold text-cyan-400">
                    {dragCanonicalQuestions.length}
                  </div>
                  <div class="text-xs text-slate-400">
                    canonical only
                  </div>
                </div>
              </div>
              <p class="text-sm text-slate-400 mb-6">
                Canonical questions only (extracted from results)
              </p>

              <!-- D-RAG Canonical Questions -->
              <div>
                <details class="group">
                  <summary class="cursor-pointer list-none">
                    <h4 class="text-md font-semibold text-cyan-300 mb-3 flex items-center gap-2 inline-flex">
                      <span class="group-open:rotate-90 transition-transform">‚ñ∂</span>
                      <span>‚úì</span> Canonical ({dragCanonicalQuestions.length}/{totalCanonicalQuestions})
                      <span class="text-xs text-slate-400 font-normal ml-2">Click to expand</span>
                    </h4>
                  </summary>
                  {dragCanonicalQuestions.length > 0 ? (
                    <div class="mt-3 space-y-2 max-h-96 overflow-y-auto">
                      {dragCanonicalQuestions.map((q) => (
                        <div class="p-3 bg-slate-800/50 rounded border border-slate-700 hover:border-cyan-500/50 transition-colors">
                          <div class="flex items-start justify-between gap-2 mb-1">
                            <span class="font-mono text-xs text-cyan-400">{q.id}</span>
                            <span class="text-xs px-2 py-0.5 rounded bg-purple-500/20 text-purple-400">
                              {q.sector}
                            </span>
                          </div>
                          <div class="text-sm text-slate-300">{q.text}</div>
                          <div class="text-xs text-slate-500 mt-1">{q.category}</div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div class="mt-3 p-6 bg-slate-800/30 rounded border border-slate-700 text-center">
                      <p class="text-slate-400 text-sm">No D-RAG results available</p>
                    </div>
                  )}
                </details>
              </div>

              <div class="mt-6 p-4 bg-cyan-500/10 rounded border border-cyan-500/20">
                <p class="text-xs text-slate-400">
                  <strong class="text-cyan-400">Note:</strong> D-RAG uses only canonical questions.
                  Company-specific variants are unique to the N-LLM system.
                </p>
              </div>
            </div>
          </div>

          <!-- Canonical Question Comparison Indicator -->
          {dragQuestions.length > 0 && (
            <div class="mt-8 p-6 bg-gradient-to-r from-emerald-500/10 via-cyan-500/10 to-cyan-500/10 rounded-lg border border-cyan-500/30">
              <h3 class="text-lg font-bold text-slate-100 mb-4 flex items-center gap-2">
                <span>üìä</span> Canonical Question Overlap Analysis
              </h3>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Common Questions -->
                <div class="text-center">
                  <div class="text-4xl font-bold text-cyan-400 mb-2">
                    {canonicalComparison.commonCount}
                  </div>
                  <div class="text-sm text-slate-300 font-semibold mb-1">Common Canonical Questions</div>
                  <div class="text-xs text-slate-400">
                    Used by both N-LLM and D-RAG
                  </div>
                  <div class="mt-2 text-xs text-cyan-300">
                    ‚úì Common questions (both systems)
                  </div>
                  {canonicalComparison.commonCount > 0 && (
                    <details class="mt-3">
                      <summary class="cursor-pointer text-xs text-cyan-400 hover:text-cyan-300">
                        View questions ‚Üí
                      </summary>
                      <div class="mt-2 text-left max-h-48 overflow-y-auto">
                        {canonicalComparison.commonCanonicals
                          .sort((a, b) => a.id.localeCompare(b.id))
                          .map(q => (
                            <div class="text-xs font-mono text-cyan-300 py-1">Q{q.id}</div>
                          ))
                        }
                      </div>
                    </details>
                  )}
                </div>

                <!-- N-LLM Only -->
                <div class="text-center">
                  <div class="text-4xl font-bold text-emerald-400 mb-2">
                    {canonicalComparison.nllmOnlyCount}
                  </div>
                  <div class="text-sm text-slate-300 font-semibold mb-1">N-LLM Only</div>
                  <div class="text-xs text-slate-400">
                    Sector-applicable canonicals
                  </div>
                  <div class="mt-2 text-xs text-slate-500">
                    Asked by N-LLM, not by D-RAG
                  </div>
                  {canonicalComparison.nllmOnlyCount > 0 && (
                    <details class="mt-3">
                      <summary class="cursor-pointer text-xs text-emerald-400 hover:text-emerald-300">
                        View questions ‚Üí
                      </summary>
                      <div class="mt-2 text-left max-h-48 overflow-y-auto">
                        {canonicalComparison.nllmOnlyCanonicals
                          .sort((a, b) => a.id.localeCompare(b.id))
                          .map(q => (
                            <div class="text-xs font-mono text-emerald-300 py-1">Q{q.id}</div>
                          ))
                        }
                      </div>
                    </details>
                  )}
                </div>

                <!-- D-RAG Only -->
                <div class="text-center">
                  <div class="text-4xl font-bold text-amber-400 mb-2">
                    {canonicalComparison.dragOnlyNonApplicableCount}
                  </div>
                  <div class="text-sm text-slate-300 font-semibold mb-1">D-RAG Only</div>
                  <div class="text-xs text-slate-400">
                    Non-sector-applicable canonicals
                  </div>
                  <div class="mt-2 text-xs text-slate-500">
                    Asked by D-RAG, not by N-LLM
                  </div>
                  {canonicalComparison.dragOnlyNonApplicableCount > 0 && (
                    <details class="mt-3">
                      <summary class="cursor-pointer text-xs text-amber-400 hover:text-amber-300">
                        View questions ‚Üí
                      </summary>
                      <div class="mt-2 text-left max-h-48 overflow-y-auto">
                        {canonicalComparison.dragOnlyNonApplicable
                          .sort((a, b) => a.id.localeCompare(b.id))
                          .map(q => (
                            <div class="text-xs font-mono text-amber-300 py-1">Q{q.id}</div>
                          ))
                        }
                      </div>
                    </details>
                  )}
                </div>
              </div>

              {/* Common Canonical Questions List - Moved here from above */}
              {canonicalComparison.commonCount > 0 && (
                <details class="mt-6 bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4">
                  <summary class="cursor-pointer text-sm font-semibold text-cyan-400 hover:text-cyan-300 flex items-center gap-2">
                    <span>‚úì</span>
                    <span>View list of {canonicalComparison.commonCount} common canonical questions</span>
                  </summary>
                  <div class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                    {canonicalComparison.commonCanonicals
                      .sort((a, b) => a.id.localeCompare(b.id))
                      .map(q => (
                        <div class="text-xs font-mono text-cyan-300 bg-slate-800 px-3 py-2 rounded border border-cyan-500/20 hover:border-cyan-500/40 transition-colors">
                          Q{q.id}
                        </div>
                      ))
                    }
                  </div>
                  <div class="mt-3 text-xs text-slate-400 italic">
                    These questions are used in the "Common Canonical" view of charts and matrix for fair comparison.
                  </div>
                </details>
              )}

              <div class="mt-6 pt-4 border-t border-slate-600">
                <p class="text-xs text-slate-400 text-center">
                  <strong class="text-cyan-400">Fair Comparison:</strong> The "Common Canonical" view in charts below uses only the {canonicalComparison.commonCount} common canonical questions to ensure direct comparison using identical question sets.
                </p>
              </div>
            </div>
          )}

          <!-- Excluded Questions -->
          {applicableInfo.totalExcluded > 0 && (
            <div class="mt-6 pt-6 border-t border-slate-700">
              <details class="group">
                <summary class="cursor-pointer list-none">
                  <h3 class="text-lg font-semibold text-red-400 mb-3 flex items-center gap-2 inline-flex">
                    <span class="group-open:rotate-90 transition-transform">‚ñ∂</span>
                    <span>‚úó</span> Excluded Questions ({applicableInfo.totalExcluded})
                    <span class="text-xs text-slate-400 font-normal ml-2">Click to expand</span>
                  </h3>
                </summary>
                <div class="mt-3 space-y-2 max-h-96 overflow-y-auto">
                  {applicableInfo.excludedCanonical.map(({ question, reason }) => (
                    <div class="p-3 bg-red-500/5 rounded border border-red-500/20">
                      <div class="flex items-start justify-between gap-2 mb-1">
                        <span class="font-mono text-xs text-red-400">{question.id}</span>
                        <span class="text-xs px-2 py-0.5 rounded bg-red-500/20 text-red-400">
                          {question.sector}
                        </span>
                      </div>
                      <div class="text-sm text-slate-300">{question.text}</div>
                      <div class="text-xs text-slate-500 mt-1">{question.category}</div>
                      <div class="text-xs text-red-400 mt-2 flex items-start gap-1">
                        <span>‚ö†</span>
                        <span class="italic">{reason}</span>
                      </div>
                    </div>
                  ))}
                </div>
              </details>
            </div>
          )}
        </div>
      </section>

      <!-- Bar Chart View - Separated Section -->
      <section class="mb-12">
        <div class="card">
          <h2 class="text-2xl font-bold text-slate-100 mb-6">üìä Classification Trends - Bar View</h2>
          <p class="text-sm text-slate-400 mb-8">
            Year-over-year comparison showing how each classification metric evolved over time.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            {/* N-LLM Bar Chart */}
            {nllmMultiYearData.length > 0 && (
              <MultiYearBarChart
                yearlyData={nllmMultiYearData}
                canonicalData={nllmCanonicalMultiYearData}
                title="N-LLM Analysis - Trends"
                color="#10b981"
                showCanonicalFilter={true}
                systemType="nllm"
              />
            )}

            {/* D-RAG Bar Chart */}
            {dragMultiYearData.length > 0 && (
              <MultiYearBarChart
                yearlyData={dragMultiYearData}
                canonicalData={dragCanonicalMultiYearData}
                title="D-RAG Baseline - Trends"
                color="#06b6d4"
                showCanonicalFilter={true}
                systemType="drag"
              />
            )}
          </div>
        </div>
      </section>

      <!-- Timeline Chart -->
      <section class="mb-12">
        <TimelineChart
          years={years}
          ourSystemData={ourQuestionsByYear}
          dragData={dragQuestionsByYear.size > 0 ? dragQuestionsByYear : undefined}
          commonCanonicalIds={commonCanonicalIds}
        />
      </section>

      <!-- Matrix View -->
      <section class="mb-12">
        <div class="card">
          <MatrixView
            questions={nllmQuestions}
            years={years}
            company={company}
            model={model}
            questionsByYear={questionsByYear}
            dragQuestionsByYear={dragQuestionsByYear}
            dragQuestions={dragQuestions}
            commonCanonicalIds={commonCanonicalIds}
          />
        </div>
      </section>

      <!-- Year-by-Year Analysis -->
      <section class="mb-12">
        <h2 class="text-2xl font-bold text-slate-100 mb-6">üìÖ Year-by-Year Results</h2>
        <div class="space-y-8">
          {yearlyData.map(({ year, nllmStats, dragStats, hasNllm, hasDrag, nllmModel, dragModel }) => (
            <div>
              <h3 class="text-lg font-bold text-slate-200 mb-4">{year}</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- N-LLM Card -->
                {hasNllm && nllmStats && (
                  <a
                    href={`/${company.toLowerCase()}/${year}${model ? `?model=${model}` : ''}`}
                    class="card hover:border-emerald-500 transition-colors cursor-pointer group border-l-4 border-l-emerald-500"
                  >
                    <div class="flex items-start justify-between mb-4">
                      <div>
                        <div class="flex items-center gap-2">
                          <h4 class="text-lg font-bold text-emerald-400">N-LLM</h4>
                          <span class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded">
                            {nllmModel}
                          </span>
                        </div>
                      </div>
                    </div>

                    <div class="space-y-2 text-sm mb-4">
                      <div class="flex justify-between">
                        <span class="text-slate-400">Questions:</span>
                        <span class="text-slate-200 font-medium">{nllmStats.total}</span>
                      </div>
                    </div>

                    <!-- Mini classification bars -->
                    <div class="space-y-1">
                      {Object.entries(nllmStats.byClassification).map(([classification, count]) => {
                        const percentage = nllmStats.total > 0 ? (count / nllmStats.total * 100) : 0;
                        const colors = {
                          YES: 'bg-emerald-500',
                          PARTIAL: 'bg-amber-500',
                          UNCLEAR: 'bg-gray-500',
                          NONE: 'bg-red-500'
                        };
                        return (
                          <div class="flex items-center gap-2 text-xs">
                            <span class="text-slate-400 w-16">{classification}</span>
                            <div class="flex-1 bg-slate-700 rounded-full h-2 overflow-hidden">
                              <div
                                class={colors[classification as keyof typeof colors]}
                                style={`width: ${percentage}%`}
                              ></div>
                            </div>
                            <span class="text-slate-400 w-8 text-right">{count}</span>
                          </div>
                        );
                      })}
                    </div>

                    <div class="mt-4 text-sm text-emerald-400 group-hover:text-emerald-300 transition-colors">
                      View N-LLM analysis ‚Üí
                    </div>
                  </a>
                )}

                <!-- D-RAG Card -->
                {hasDrag && dragStats && (
                  <a
                    href={`/${company.toLowerCase()}/${year}${model ? `?model=${model}` : ''}`}
                    class="card hover:border-cyan-500 transition-colors cursor-pointer group border-l-4 border-l-cyan-500"
                  >
                    <div class="flex items-start justify-between mb-4">
                      <div>
                        <div class="flex items-center gap-2">
                          <h4 class="text-lg font-bold text-cyan-400">D-RAG</h4>
                          <span class="text-xs bg-cyan-500/20 text-cyan-400 px-2 py-1 rounded">
                            Baseline
                          </span>
                        </div>
                      </div>
                    </div>

                    <div class="space-y-2 text-sm mb-4">
                      <div class="flex justify-between">
                        <span class="text-slate-400">Questions:</span>
                        <span class="text-slate-200 font-medium">{dragStats.total}</span>
                      </div>
                    </div>

                    <!-- Mini classification bars -->
                    <div class="space-y-1">
                      {Object.entries(dragStats.byClassification).map(([classification, count]) => {
                        const percentage = dragStats.total > 0 ? (count / dragStats.total * 100) : 0;
                        const colors = {
                          YES: 'bg-emerald-500',
                          PARTIAL: 'bg-amber-500',
                          UNCLEAR: 'bg-gray-500',
                          NONE: 'bg-red-500'
                        };
                        return (
                          <div class="flex items-center gap-2 text-xs">
                            <span class="text-slate-400 w-16">{classification}</span>
                            <div class="flex-1 bg-slate-700 rounded-full h-2 overflow-hidden">
                              <div
                                class={colors[classification as keyof typeof colors]}
                                style={`width: ${percentage}%`}
                              ></div>
                            </div>
                            <span class="text-slate-400 w-8 text-right">{count}</span>
                          </div>
                        );
                      })}
                    </div>

                    <div class="mt-4 text-sm text-cyan-400 group-hover:text-cyan-300 transition-colors">
                      View D-RAG analysis ‚Üí
                    </div>
                  </a>
                )}

                <!-- Placeholder if only one system available -->
                {!hasNllm && hasDrag && (
                  <div class="card border-slate-700 opacity-50">
                    <div class="text-center py-8 text-slate-500">
                      <p>N-LLM analysis not available for this year</p>
                    </div>
                  </div>
                )}
                {hasNllm && !hasDrag && (
                  <div class="card border-slate-700 opacity-50">
                    <div class="text-center py-8 text-slate-500">
                      <p>D-RAG analysis not available for this year</p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </section>

      <!-- Category Breakdown -->
      <section>
        <h2 class="text-2xl font-bold text-slate-100 mb-6">üè∑Ô∏è Risk Categories</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          {Array.from(groupedByCategory.entries()).map(([categoryName, questions]) => {
            // Skip empty question arrays
            if (!questions || questions.length === 0) return null;

            const stats = calculateCategoryStats(questions);
            const categoryInfo = getCategoryGroup(questions[0]);
            return (
              <div class="card">
                <div class="flex items-center gap-2 mb-4">
                  <span class="text-2xl">{categoryInfo.icon}</span>
                  <h3 class="text-lg font-bold text-slate-100">{categoryName}</h3>
                </div>
                <div class="text-sm text-slate-400 mb-4">
                  {categoryInfo.description}
                </div>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-slate-400">Questions:</span>
                    <span class="text-slate-200 font-medium">{questions.length}</span>
                  </div>
                  <div class="mt-3 pt-3 border-t border-slate-700 space-y-1">
                    {Object.entries(stats.byClassification).map(([cls, count]) => (
                      <div class="flex justify-between text-xs">
                        <span class="text-slate-400">{cls}:</span>
                        <span class="text-slate-200">{count}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 border-t border-slate-700 mt-12">
      <div class="container mx-auto px-6 py-6 text-center text-slate-400 text-sm">
        <p>Agricultural Document Analyzer - D-Rag Validation System</p>
      </div>
    </footer>
  </div>
</Layout>
