---
/**
 * Analytics Page
 * Cross-company insights, benchmarking, and comparative analysis
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/layout/Header.astro';
import Breadcrumb from '../components/layout/Breadcrumb.astro';
import TrendsInsights from '../components/analytics/TrendsInsights.astro';
import QuestionBenchmark from '../components/analytics/QuestionBenchmark.astro';
import RadarComparison from '../components/analytics/RadarComparison.astro';
import CategoryDeepDive from '../components/analytics/CategoryDeepDive.astro';
import BinaryDisclosureCharts from '../components/analytics/BinaryDisclosureCharts.astro';

import { loadAllCompanyData } from '../utils/dataLoader';
import {
  calculateCompanyMetrics,
  calculateCrossCompanyMetrics,
  normalizeTimeframeCategory,
  normalizeFinancialDisclosureType
} from '../utils/metricsCalculator';

// Load all company data (fallback to team-reviewed combined if no verified files are present)
let allCompanyData = await loadAllCompanyData();
if (allCompanyData.length === 0) {
  try {
    const teamReviewed = (await import('../../results/team_reviewed_json/team_reviewed_combined_collapsed.json')).default;
    if (Array.isArray(teamReviewed) && teamReviewed.length > 0) {
      allCompanyData = teamReviewed as any[];
    }
  } catch (error) {
    console.warn('No verified data and could not load team_reviewed_combined_collapsed.json');
  }
}

// Calculate metrics for each company
const companyMetrics = allCompanyData.map(data =>
  calculateCompanyMetrics(data.verified)
);

// Calculate cross-company metrics
const crossCompanyMetrics = calculateCrossCompanyMetrics(companyMetrics, allCompanyData);

// Build breadcrumb items
const baseUrl = import.meta.env.BASE_URL;
const breadcrumbItems = [
  { label: 'Home', href: baseUrl },
  { label: 'Analytics', href: `${baseUrl}/analytics`, current: true }
];

type CountPair = { disclosure: number; noDisclosure: number };

const collapseClassification = (value: string) =>
  value === 'FULL_DISCLOSURE' || value === 'PARTIAL' ? 'Disclosure' : 'No Disclosure';

function bumpCount(map: Map<string, CountPair>, key: string, isDisclosure: boolean) {
  const entry = map.get(key) || { disclosure: 0, noDisclosure: 0 };
  if (isDisclosure) entry.disclosure += 1;
  else entry.noDisclosure += 1;
  map.set(key, entry);
}

const categoryMap = new Map<string, CountPair>();
const timeframeMap = new Map<string, CountPair>();
const framingMap = new Map<string, CountPair>();
const companyMap = new Map<string, CountPair>();
const questionMap = new Map<string, { question_text: string; category: string; disclosure: number; total: number }>();
const categoryTimeframeMap = new Map<string, { category: string; timeframe: string; disclosure: number; total: number }>();
const categoryFramingMap = new Map<string, { category: string; framing: string; disclosure: number; total: number }>();
const categoryFinancialMap = new Map<string, { category: string; full: number; partial: number; non: number; total: number }>();
const categoryFramingFinancialMap = new Map<string, { category: string; framing: string; financial: string; count: number }>();
const categoryTotalsForMix = new Map<string, number>();

let overallDisclosure = 0;
let overallNoDisclosure = 0;

allCompanyData.forEach(bundle => {
  const company = bundle.verified.company_name;
  const year = bundle.verified.fiscal_year;
  const companyKey = `${company} ${year}`;

  bundle.verified.analysis_results.forEach(question => {
    const questionKey = question.question_id;
    const questionEntry =
      questionMap.get(questionKey) ||
      {
        question_text: question.question_text,
        category: question.category || 'Unknown',
        disclosure: 0,
        total: 0
      };

    const hasDisclosure = question.disclosures.some(
      snippet => collapseClassification(snippet.classification) === 'Disclosure'
    );
    questionEntry.total += 1;
    if (hasDisclosure) questionEntry.disclosure += 1;
    questionMap.set(questionKey, questionEntry);

    if (question.disclosures.length === 0) {
      // If no snippets, treat as a no-disclosure question entry but skip snippet-level charts
      bumpCount(categoryMap, question.category || 'Unknown', false);
      bumpCount(companyMap, companyKey, false);
      const tfKey = normalizeTimeframeCategory('');
      bumpCount(timeframeMap, tfKey, false);
      bumpCount(framingMap, 'Unknown', false);
      const ctKey = `${question.category || 'Unknown'}__${tfKey}`;
      const ctEntry =
        categoryTimeframeMap.get(ctKey) || {
          category: question.category || 'Unknown',
          timeframe: tfKey,
          disclosure: 0,
          total: 0
        };
      ctEntry.total += 1;
      categoryTimeframeMap.set(ctKey, ctEntry);
      overallNoDisclosure += 1;
      return;
    }

    question.disclosures.forEach(snippet => {
      const collapsed = collapseClassification(snippet.classification);
      const isDisclosure = collapsed === 'Disclosure';
      const timeframe = normalizeTimeframeCategory(snippet.categorization.timeframe);
      const framing = snippet.categorization.framing || 'Unknown';
      const category = question.category || 'Unknown';
      const financialType = normalizeFinancialDisclosureType(snippet.categorization.financial_type);

      bumpCount(categoryMap, category, isDisclosure);
      bumpCount(timeframeMap, timeframe, isDisclosure);
      bumpCount(framingMap, framing, isDisclosure);
      bumpCount(companyMap, companyKey, isDisclosure);

      const ctKey = `${category}__${timeframe}`;
      const existing = categoryTimeframeMap.get(ctKey) || {
        category,
        timeframe,
        disclosure: 0,
        total: 0
      };
      existing.total += 1;
      if (isDisclosure) existing.disclosure += 1;
      categoryTimeframeMap.set(ctKey, existing);

      const cfKey = `${category}__${framing}`;
      const cfExisting = categoryFramingMap.get(cfKey) || {
        category,
        framing,
        disclosure: 0,
        total: 0
      };
      cfExisting.total += 1;
      if (isDisclosure) cfExisting.disclosure += 1;
      categoryFramingMap.set(cfKey, cfExisting);

      const finExisting = categoryFinancialMap.get(category) || {
        category,
        full: 0,
        partial: 0,
        non: 0,
        total: 0
      };
      finExisting.total += 1;
      if (financialType === 'Financial') finExisting.full += 1;
      else if (financialType === 'Partial-type') finExisting.partial += 1;
      else finExisting.non += 1;
      categoryFinancialMap.set(category, finExisting);

      // Category x Framing x FinancialType cube
      const cffKey = `${category}__${framing}__${financialType}`;
      const cffExisting = categoryFramingFinancialMap.get(cffKey) || {
        category,
        framing,
        financial: financialType,
        count: 0
      };
      cffExisting.count += 1;
      categoryFramingFinancialMap.set(cffKey, cffExisting);
      categoryTotalsForMix.set(category, (categoryTotalsForMix.get(category) || 0) + 1);

      if (isDisclosure) overallDisclosure += 1;
      else overallNoDisclosure += 1;
    });
  });
});

const categoryRates = Array.from(categoryMap.entries()).map(([label, counts]) => ({ label, ...counts }));
const timeframeRates = Array.from(timeframeMap.entries()).map(([label, counts]) => ({ label, ...counts }));
const framingRates = Array.from(framingMap.entries()).map(([label, counts]) => ({ label, ...counts }));
const companyRates = Array.from(companyMap.entries()).map(([label, counts]) => ({ label, ...counts }));
const questionRates = Array.from(questionMap.entries()).map(([question_id, entry]) => ({
  question_id,
  question_text: entry.question_text,
  category: entry.category,
  disclosure: entry.disclosure,
  total: entry.total
}));
const categoryTimeframe = Array.from(categoryTimeframeMap.values());
const categoryFraming = Array.from(categoryFramingMap.values());
const categoryFinancial = Array.from(categoryFinancialMap.values());
const categoryFramingFinancial = Array.from(categoryFramingFinancialMap.values()).map(row => {
  const totalCat = categoryTotalsForMix.get(row.category) || 1;
  return {
    ...row,
    pct: (row.count / totalCat) * 100
  };
});
const totalDisclosureAcrossCategories = categoryRates.reduce((sum, c) => sum + c.disclosure, 0) || 1;
const categoryShare = categoryRates.map(c => ({
  label: c.label,
  shareDisclosure: (c.disclosure / totalDisclosureAcrossCategories) * 100,
  disclosure: c.disclosure
}));

const questionVolatility = questionRates
  .map(q => {
    const pct = q.total ? q.disclosure / q.total : 0;
    const volatility = pct * (1 - pct); // peaks near 0.5, zero at 0 or 1
    return { ...q, pct, volatility };
  })
  .sort((a, b) => b.volatility - a.volatility);

const binaryDisclosureData = {
  overall: { disclosure: overallDisclosure, noDisclosure: overallNoDisclosure },
  categoryRates,
  timeframeRates,
  framingRates,
  companyRates,
  questionRates,
  categoryTimeframe,
  categoryFraming,
  questionVolatility,
  categoryFinancial,
  categoryFramingFinancial,
  categoryShare
};
---

<Layout title="Analytics - Cross-Company Insights">
  <Header currentPath="/analytics" />

  <main class="min-h-screen bg-slate-950 text-slate-100">
    <!-- Hero -->
    <section class="border-b border-slate-800 bg-slate-950/85">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <Breadcrumb items={breadcrumbItems} />

        <div class="mt-10 grid gap-8 lg:grid-cols-[minmax(0,1fr)_320px]">
          <div>
            <h1 class="text-4xl sm:text-[42px] font-semibold tracking-tight text-slate-50">
              Analytics &amp; Insights
            </h1>
            <p class="mt-4 text-base sm:text-lg text-slate-300 max-w-3xl">
              Cross-company benchmarking, performance analysis, and actionable intelligence to elevate disclosure quality across the agricultural sector.
            </p>
          </div>

          <div class="surface p-5 rounded-2xl border border-slate-700/70 shadow-xl shadow-slate-950/40">
            <div class="text-xs uppercase tracking-[0.28em] text-slate-400 mb-3">
              Snapshot
            </div>
            <ul class="space-y-3 text-sm text-slate-300">
              <li class="flex items-center justify-between gap-4">
                <span class="text-slate-400">Industry Leader</span>
                {crossCompanyMetrics.global_stats.best_company ? (
                  <span class="font-semibold text-sky-300">
                    {crossCompanyMetrics.global_stats.best_company.company_name}
                  </span>
                ) : (
                  <span class="text-slate-500">TBD</span>
                )}
              </li>
              <li class="flex items-center justify-between gap-4">
                <span class="text-slate-400">Evidence Depth Avg</span>
                <span class="font-semibold text-slate-100">
                  {(crossCompanyMetrics.global_stats.total_snippets / Math.max(crossCompanyMetrics.global_stats.total_questions, 1)).toFixed(1)} snippets
                </span>
              </li>
              <li class="flex items-center justify-between gap-4">
                <span class="text-slate-400">Present-Day Focus</span>
                <span class="font-semibold text-amber-300">
                  {crossCompanyMetrics.global_stats.average_temporal_present_day_rate_all.toFixed(1)}%
                </span>
              </li>
            </ul>
          </div>
        </div>

        <!-- Global Stats -->
        <div class="mt-12 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
          <div class="surface p-5 text-center sm:text-left">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-2">Companies</p>
            <p class="text-3xl font-semibold text-slate-50">
              {crossCompanyMetrics.global_stats.total_companies}
            </p>
            <p class="text-xs text-slate-400 mt-1">with verified disclosure reviews</p>
          </div>
          <div class="surface p-5 text-center sm:text-left">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-2">Questions</p>
            <p class="text-3xl font-semibold text-slate-50">
              {crossCompanyMetrics.global_stats.total_questions}
            </p>
            <p class="text-xs text-slate-400 mt-1">analyzed for transparency</p>
          </div>
          <div class="surface p-5 text-center sm:text-left">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-2">Evidence Snippets</p>
            <p class="text-3xl font-semibold text-slate-50">
              {crossCompanyMetrics.global_stats.total_snippets}
            </p>
            <p class="text-xs text-slate-400 mt-1">triangulated citations</p>
          </div>
          <div class="surface p-5 text-center sm:text-left">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-2">Financial Rate</p>
            <p class="text-3xl font-semibold text-emerald-300">
              {crossCompanyMetrics.global_stats.average_financial_rate_all.toFixed(1)}%
            </p>
            <p class="text-xs text-slate-400 mt-1">with financial data</p>
          </div>
          <div class="surface p-5 text-center sm:text-left">
            <p class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-2">Present Day Rate</p>
            <p class="text-3xl font-semibold text-amber-300">
              {crossCompanyMetrics.global_stats.average_temporal_present_day_rate_all.toFixed(1)}%
            </p>
            <p class="text-xs text-slate-400 mt-1">current timeframe disclosures</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Content -->
    <section class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-10">
      <!-- Navigation Tabs -->
      <div class="surface px-3 py-3 sm:px-4 sm:py-4 border border-slate-700/60">
        <div class="flex flex-wrap gap-2" role="tablist" aria-label="Analytics sections">
          <button
            class="nav-tab flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all duration-200 border border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/60"
            data-target="insights"
            aria-pressed="true"
          >
            <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
            </svg>
            Key Insights
          </button>
          <button
            class="nav-tab flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all duration-200 border border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/60"
            data-target="questions"
            aria-pressed="false"
          >
            <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Question Benchmark
          </button>
          <button
            class="nav-tab flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all duration-200 border border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/60"
            data-target="disclosure"
            aria-pressed="false"
          >
            <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Disclosure Patterns
          </button>
          <button
            class="nav-tab flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all duration-200 border border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/60"
            data-target="comparison"
            aria-pressed="false"
          >
            <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
            </svg>
            Company Comparison
          </button>
          <button
            class="nav-tab flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold transition-all duration-200 border border-transparent text-slate-400 hover:text-slate-200 hover:border-slate-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500/60"
            data-target="categories"
            aria-pressed="false"
          >
            <svg class="w-4 h-4 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
            </svg>
            Category Deep Dive
          </button>
        </div>
      </div>

      <!-- Panels -->
      <div class="space-y-10">
        <div id="tab-insights" class="tab-content">
          <TrendsInsights crossCompanyMetrics={crossCompanyMetrics} />
        </div>

        <div id="tab-questions" class="tab-content hidden">
          <QuestionBenchmark crossCompanyMetrics={crossCompanyMetrics} />
        </div>

        <div id="tab-disclosure" class="tab-content hidden">
          <BinaryDisclosureCharts
            overall={binaryDisclosureData.overall}
            categoryRates={binaryDisclosureData.categoryRates}
            timeframeRates={binaryDisclosureData.timeframeRates}
            framingRates={binaryDisclosureData.framingRates}
            companyRates={binaryDisclosureData.companyRates}
            questionRates={binaryDisclosureData.questionRates}
            categoryTimeframe={binaryDisclosureData.categoryTimeframe}
            categoryFraming={binaryDisclosureData.categoryFraming}
            questionVolatility={binaryDisclosureData.questionVolatility}
            categoryFinancial={binaryDisclosureData.categoryFinancial}
          />
        </div>

        <div id="tab-comparison" class="tab-content hidden">
          <RadarComparison companyMetrics={companyMetrics} />
        </div>

        <div id="tab-categories" class="tab-content hidden">
          <CategoryDeepDive crossCompanyMetrics={crossCompanyMetrics} />
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const navTabs = document.querySelectorAll<HTMLButtonElement>('.nav-tab');
    const tabContents = document.querySelectorAll<HTMLElement>('.tab-content');

    const activeClasses = [
      'bg-slate-900/70',
      'border-slate-600',
      'text-sky-300',
      'shadow-[0_18px_36px_-18px_rgba(56,189,248,0.55)]'
    ];

    const inactiveClasses = ['bg-transparent', 'border-transparent', 'text-slate-400'];

    function setActiveTab(targetId: string) {
      navTabs.forEach(tab => {
        const isTarget = tab.dataset.target === targetId;
        tab.setAttribute('aria-pressed', String(isTarget));

        if (isTarget) {
          tab.classList.remove(...inactiveClasses);
          tab.classList.add(...activeClasses);
        } else {
          tab.classList.remove(...activeClasses);
          tab.classList.add(...inactiveClasses);
        }
      });

      tabContents.forEach(content => {
        if (content.id === `tab-${targetId}`) {
          content.classList.remove('hidden');
          content.classList.add('block');
        } else {
          content.classList.add('hidden');
          content.classList.remove('block');
        }
      });
    }

    navTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.getAttribute('data-target');
        if (target) {
          setActiveTab(target);
        }
      });
    });

    // Initialize default active state
    setActiveTab('insights');
  });
</script>

<style>
  .tab-content {
    animation: fadeIn 0.28s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
